<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase接続テスト</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Firebase接続診断ツール</h1>

  <div id="results"></div>

  <button onclick="runDiagnostics()" style="padding: 10px 20px; font-size: 16px;">診断実行</button>

  <!-- Firebase SDKをCDNから読み込み -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    function addResult(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.innerHTML = message;
      document.getElementById('results').appendChild(div);
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
    }

    async function runDiagnostics() {
      clearResults();

      addResult('🔍 Firebase診断を開始します...', 'info');

      // Step 1: Firebase SDK 確認
      try {
        if (typeof window.firebase === 'undefined') {
          addResult('❌ Firebase SDK が読み込まれていません', 'error');
          return;
        } else {
          addResult('✅ Firebase SDK が正常に読み込まれました', 'success');
          addResult(`📦 Firebase バージョン: ${firebase.SDK_VERSION}`, 'info');
        }
      } catch (error) {
        addResult(`❌ Firebase SDK チェックエラー: ${error.message}`, 'error');
        return;
      }

      // Step 2: Firebase 設定
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyC8_B2eo47C2plYkGPq_ek6VaD113tNEBk",
          authDomain: "oral-health-diagnosis-ap-b3592.firebaseapp.com",
          projectId: "oral-health-diagnosis-ap-b3592",
          storageBucket: "oral-health-diagnosis-ap-b3592.firebasestorage.app",
          messagingSenderId: "338073541462",
          appId: "1:338073541462:web:f48f281cf84710ce7794f7",
          measurementId: "G-XLQ1FVCHN5"
        };

        addResult('🔧 Firebase 設定値:', 'info');
        addResult(`<pre>${JSON.stringify(firebaseConfig, null, 2)}</pre>`, 'info');

        // Step 3: Firebase初期化
        let app;
        if (!firebase.apps.length) {
          app = firebase.initializeApp(firebaseConfig);
          addResult('✅ Firebase アプリが正常に初期化されました', 'success');
        } else {
          app = firebase.app();
          addResult('✅ 既存の Firebase アプリを使用しています', 'success');
        }

        addResult(`📱 アプリ名: ${app.name}`, 'info');
        addResult(`🏗️ プロジェクトID: ${app.options.projectId}`, 'info');

        // Step 4: Auth サービス
        try {
          const auth = firebase.auth();
          addResult('✅ Firebase Authentication サービスが利用可能です', 'success');

          // 認証状態確認
          const user = auth.currentUser;
          if (user) {
            addResult(`👤 現在のユーザー: ${user.email}`, 'success');
          } else {
            addResult('👤 現在未ログインです', 'info');
          }
        } catch (authError) {
          addResult(`❌ Authentication エラー: ${authError.message}`, 'error');
        }

        // Step 5: Firestore サービス
        try {
          const firestore = firebase.firestore();
          addResult('✅ Firebase Firestore サービスが利用可能です', 'success');

          // 接続テスト
          await firestore.enableNetwork();
          addResult('✅ Firestore への接続が確認できました', 'success');

        } catch (firestoreError) {
          addResult(`❌ Firestore エラー: ${firestoreError.message}`, 'error');
        }

        // Step 6: ネットワーク接続テスト
        try {
          const response = await fetch('https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js', {
            method: 'HEAD'
          });

          if (response.ok) {
            addResult('✅ Firebase CDN への接続が正常です', 'success');
          } else {
            addResult(`⚠️ Firebase CDN 接続に問題があります (${response.status})`, 'error');
          }
        } catch (networkError) {
          addResult(`❌ ネットワークエラー: ${networkError.message}`, 'error');
        }

        addResult('🎉 診断が完了しました', 'success');

      } catch (error) {
        addResult(`❌ 初期化エラー: ${error.message}`, 'error');
        console.error('Firebase診断エラー:', error);
      }
    }

    // ページ読み込み時に自動実行
    document.addEventListener('DOMContentLoaded', () => {
      addResult('📋 Firebase 診断ツールが準備完了しました', 'info');
    });
  </script>
</body>
</html>