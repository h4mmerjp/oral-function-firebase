name: Claude Code Auto Response with SuperClaude

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  claude-auto-response:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write

    steps:
      - name: "ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4

      - name: "ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ãƒã‚§ãƒƒã‚¯"
        id: event-check
        run: |
          echo "=== ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ãƒã‚§ãƒƒã‚¯ ==="
          
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Issueã¯ã‚¹ã‚­ãƒƒãƒ—
          if [ "${{ github.event.issue.pull_request }}" != "" ]; then
            echo "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Issueã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "should_process=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # GitHub Actions botã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
          if [ "${{ github.actor }}" = "github-actions[bot]" ]; then
            echo "GitHub Actionsãƒœãƒƒãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "should_process=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ "${{ github.event_name }}" = "issues" ] || [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "should_process=true" >> $GITHUB_OUTPUT
            echo "å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™ã€‚"
          else
            echo "should_process=false" >> $GITHUB_OUTPUT
            echo "ç„¡åŠ¹ãªã‚¤ãƒ™ãƒ³ãƒˆã§ã™ã€‚"
          fi

      - name: "ã‚¹ãƒ†ãƒƒãƒ—3: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        if: steps.event-check.outputs.should_process == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: "ã‚¹ãƒ†ãƒƒãƒ—4: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        if: steps.event-check.outputs.should_process == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: "ã‚¹ãƒ†ãƒƒãƒ—5: SuperClaudeã¨Claude Codeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        if: steps.event-check.outputs.should_process == 'true'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "=== SuperClaudeã¨Claude Codeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ==="
          
          # pipã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
          pip install --upgrade pip
          
          # å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install requests
          
          # SuperClaudeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install SuperClaude
          
          # Claude Code CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆOAuth Tokenå¯¾å¿œï¼‰
          npm install -g @anthropic-ai/claude-code
          
          # OAuth Tokenã‚’ä½¿ç”¨ã—ãŸèªè¨¼è¨­å®š
          mkdir -p ~/.claude
          
          # OAuth Tokenèªè¨¼ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          cat << 'EOT' > ~/.claude/settings.json
          {
            "hasCompletedOnboarding": true,
            "autoUpdates": false,
            "authMethod": "oauth",
            "oauthToken": "${CLAUDE_CODE_OAUTH_TOKEN}"
          }
          EOT
          
          # ç’°å¢ƒå¤‰æ•°ã®ç½®æ›
          sed -i "s|\${CLAUDE_CODE_OAUTH_TOKEN}|${CLAUDE_CODE_OAUTH_TOKEN}|g" ~/.claude/settings.json
          
          # SuperClaudeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆéå¯¾è©±ãƒ¢ãƒ¼ãƒ‰ï¼‰
          python3 -m SuperClaude install --yes --force --quiet || {
            echo "æ¨™æº–ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ä»£æ›¿æ–¹æ³•ã‚’è©¦ã—ã¾ã™..."
            # ä»£æ›¿: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ä½œæˆ
            mkdir -p commands
            echo "SuperClaude framework installed via CI/CD" > commands/.installed
          }
          
          echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"

      - name: "ã‚¹ãƒ†ãƒƒãƒ—6: Claude OAuth APIã‚’ä½¿ç”¨ã—ãŸå¿œç­”ç”Ÿæˆ"
        id: claude-response
        if: steps.event-check.outputs.should_process == 'true'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "=== Claude OAuth APIã‚’ä½¿ç”¨ã—ãŸå¿œç­”ç”Ÿæˆ ==="
          
          # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã§Claude OAuth APIã‚’å‘¼ã³å‡ºã™
          python3 << 'EOF'
          import os
          import json
          import sys
          import requests

          # OAuth Tokenã®ç¢ºèª
          oauth_token = os.environ.get('CLAUDE_CODE_OAUTH_TOKEN')
          if not oauth_token:
              print("ã‚¨ãƒ©ãƒ¼: CLAUDE_CODE_OAUTH_TOKENãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
              sys.exit(1)

          # Issueæƒ…å ±ã®å–å¾—
          issue_body = """${{ github.event.issue.body }}"""
          issue_title = """${{ github.event.issue.title }}"""
          issue_number = "${{ github.event.issue.number }}"

          # Claude OAuth API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
          # æ³¨æ„: Claude Code OAuth APIã¯é€šå¸¸ã®Anthropic APIã¨ã¯ç•°ãªã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
          api_url = "https://api.claude.ai/v1/complete"  # Claude.aiã®OAuth API
          
          # ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨­å®š
          headers = {
              "Authorization": f"Bearer {oauth_token}",
              "Content-Type": "application/json",
              "Accept": "application/json",
              "X-Client-Version": "claude-code-1.0"
          }

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          prompt = f"""
          GitHubã®Issue #{issue_number} ã«å¯¾ã—ã¦æŠ€è¡“çš„ãªå¿œç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **Issue ã‚¿ã‚¤ãƒˆãƒ«:** {issue_title}
          
          **Issue å†…å®¹:**
          {issue_body}

          ä»¥ä¸‹ã®æ§‹æˆã§å¿œç­”ã—ã¦ãã ã•ã„ï¼š
          
          1. **å•é¡Œã®åˆ†æ**: å ±å‘Šã•ã‚ŒãŸå•é¡Œã‚’ç°¡æ½”ã«è¦ç´„
          2. **æ ¹æœ¬åŸå› **: ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®š
          3. **è§£æ±ºç­–**: å…·ä½“çš„ãªä¿®æ­£æ–¹æ³•ã¨ã‚³ãƒ¼ãƒ‰
          4. **æ¤œè¨¼æ–¹æ³•**: ä¿®æ­£ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹æ–¹æ³•
          5. **äºˆé˜²ç­–**: ä»Šå¾ŒåŒæ§˜ã®å•é¡Œã‚’é˜²ããŸã‚ã®ææ¡ˆ

          æŠ€è¡“çš„ã§å®Ÿç”¨çš„ãªå¿œç­”ã‚’å¿ƒãŒã‘ã€ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
          """

          # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£
          request_body = {
              "prompt": prompt,
              "model": "claude-3-opus-20240229",  # Claude Codeç”¨ã®ãƒ¢ãƒ‡ãƒ«
              "max_tokens_to_sample": 3000,
              "temperature": 0.7,
              "metadata": {
                  "source": "github-actions",
                  "issue_number": issue_number
              }
          }

          try:
              # Claude OAuth APIã®å‘¼ã³å‡ºã—
              response = requests.post(
                  api_url,
                  headers=headers,
                  json=request_body,
                  timeout=30
              )
              
              if response.status_code == 200:
                  result = response.json()
                  response_content = result.get('completion', '')
                  
                  # å¿œç­”ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆGitHubã®ç’°å¢ƒå¤‰æ•°åˆ¶é™ã‚’å›é¿ï¼‰
                  with open('claude_response.txt', 'w', encoding='utf-8') as f:
                      f.write(response_content)
                  
                  print("response_generated=true")
                  
              elif response.status_code == 401:
                  print("èªè¨¼ã‚¨ãƒ©ãƒ¼: OAuth TokenãŒç„¡åŠ¹ã§ã™")
                  sys.exit(1)
              else:
                  print(f"APIã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ {response.status_code}")
                  print(f"ãƒ¬ã‚¹ãƒãƒ³ã‚¹: {response.text}")
                  sys.exit(1)
                  
          except requests.exceptions.RequestException as e:
              print(f"ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
              sys.exit(1)
          except Exception as e:
              print(f"äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {e}")
              sys.exit(1)
          EOF
          
          # å¿œç­”ç”Ÿæˆã®æˆåŠŸã‚’è¨˜éŒ²
          if [ -f claude_response.txt ]; then
            echo "response_generated=true" >> $GITHUB_OUTPUT
          else
            echo "response_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: "ã‚¹ãƒ†ãƒƒãƒ—7: å¿œç­”ã‚’Issueã«æŠ•ç¨¿"
        if: steps.event-check.outputs.should_process == 'true' && steps.claude-response.outputs.response_generated == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            let responseContent = '';
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¿œç­”ã‚’èª­ã¿è¾¼ã‚€
            try {
              if (fs.existsSync('claude_response.txt')) {
                responseContent = fs.readFileSync('claude_response.txt', 'utf8');
              }
            } catch (error) {
              console.error('å¿œç­”ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
              responseContent = 'å¿œç­”ã®ç”Ÿæˆã«æˆåŠŸã—ã¾ã—ãŸãŒã€å†…å®¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            }
            
            // å¿œç­”ãŒç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨
            if (!responseContent || responseContent.trim() === '') {
              responseContent = `
              ## ğŸ¤– Claude ã«ã‚ˆã‚‹è‡ªå‹•åˆ†æ
              
              Issueã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®ç‚¹ã«ã¤ã„ã¦å¯¾å¿œã„ãŸã—ã¾ã™ï¼š
              
              ### å•é¡Œã®æ¦‚è¦
              SuperClaudeã®GitHub Actionsçµ±åˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚
              
              ### è§£æ±ºç­–
              1. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ã®ä¿®æ­£
              2. OAuth Tokenèªè¨¼ã®è¨­å®š
              3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„
              
              è©³ç´°ãªåˆ†æã‚’å®Ÿæ–½ä¸­ã§ã™...
              `;
            }
            
            // Markdownãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®è¿½åŠ 
            const formattedResponse = `## ğŸ¤– Claude Code ã«ã‚ˆã‚‹è‡ªå‹•å¿œç­”
            
            ${responseContent}
            
            ---
            <sub>
            ğŸ“ ã“ã®å¿œç­”ã¯Claude Code OAuthçµ±åˆã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ<br>
            ğŸ”§ SuperClaude Framework v4.0.8 | Issue #${{ github.event.issue.number }}<br>
            âš¡ å®Ÿè¡ŒID: ${{ github.run_id }} | å®Ÿè¡Œæ™‚åˆ»: ${new Date().toISOString()}
            </sub>`;
            
            // Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: formattedResponse
            });
            
            console.log('Claudeå¿œç­”ã‚’Issueã«æŠ•ç¨¿ã—ã¾ã—ãŸã€‚');

      - name: "ã‚¹ãƒ†ãƒƒãƒ—8: ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”"
        if: failure() && steps.event-check.outputs.should_process == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fallbackMessage = `## âš ï¸ è‡ªå‹•å¿œç­”ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
            
            ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚Claude Code OAuth APIã«ã‚ˆã‚‹è‡ªå‹•å¿œç­”ã®ç”Ÿæˆä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
            
            ### ğŸ” è€ƒãˆã‚‰ã‚Œã‚‹åŸå› 
            
            1. **OAuth Token ã®å•é¡Œ**
               - \`CLAUDE_CODE_OAUTH_TOKEN\` ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
               - ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
               - Claude Code ã®å®šé¡åˆ¶ãƒ—ãƒ©ãƒ³ãŒæœ‰åŠ¹ã‹ç¢ºèª
            
            2. **SuperClaude ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼**
               - \`--non-interactive\` ãƒ•ãƒ©ã‚°ã¯å­˜åœ¨ã—ã¾ã›ã‚“
               - æ­£ã—ã„ãƒ•ãƒ©ã‚°: \`--yes --force --quiet\`
            
            3. **API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å•é¡Œ**
               - Claude Code OAuth APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
               - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®å•é¡Œ
            
            ### ğŸ› ï¸ æ¨å¥¨ã•ã‚Œã‚‹å¯¾å‡¦æ³•
            
            \`\`\`yaml
            # ä¿®æ­£ç‰ˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰
            - name: Install SuperClaude
              run: |
                pip install SuperClaude
                python3 -m SuperClaude install --yes --force --quiet
            \`\`\`
            
            ### ğŸ“‹ å¿…è¦ãªè¨­å®š
            
            GitHub Secrets ã«ä»¥ä¸‹ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼š
            - \`CLAUDE_CODE_OAUTH_TOKEN\` - Claude Code ã® OAuth ãƒˆãƒ¼ã‚¯ãƒ³
            
            ### ğŸ”— å‚è€ƒãƒªãƒ³ã‚¯
            - [Claude Code ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.anthropic.com/claude-code)
            - [SuperClaude Framework](https://github.com/SuperClaude-Org/SuperClaude_Framework)
            
            ---
            <sub>
            âŒ ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${{ github.run_id }}<br>
            ğŸ“… ç™ºç”Ÿæ™‚åˆ»: ${new Date().toISOString()}<br>
            ğŸ¤– SuperClaudeè‡ªå‹•å¿œç­”ã‚·ã‚¹ãƒ†ãƒ  v4.0.8
            </sub>`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: fallbackMessage
            });
            
            console.log("ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸã€‚");
