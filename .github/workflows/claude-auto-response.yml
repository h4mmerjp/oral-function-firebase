# .github/workflows/claude-auto-response.yml
name: Claude Code Auto Response

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  claude-auto-response:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
      actions: write
      metadata: read

    steps:
      # ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ã®ãŸã‚ã®ãƒã‚§ãƒƒã‚¯ï¼ˆå¼·åŒ–ç‰ˆï¼‰
      - name: Check if comment is from bot
        id: bot-check
        run: |
          echo "=== Bot ãƒã‚§ãƒƒã‚¯ ==="

          # Issueä½œæˆã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "is_bot=false" >> $GITHUB_OUTPUT
            echo "should_process=true" >> $GITHUB_OUTPUT
            echo "Issueä½œæˆã‚¤ãƒ™ãƒ³ãƒˆ - å‡¦ç†ã‚’ç¶™ç¶š"
            exit 0
          fi

          # ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆã®å ´åˆ
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
            COMMENT_TYPE="${{ github.event.comment.user.type }}"
            
            echo "ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆè€…: $COMMENT_AUTHOR"
            echo "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—: $COMMENT_TYPE"
            
            # Botã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ˆã‚Šå³å¯†ã«ï¼‰
            if [ "$COMMENT_TYPE" = "Bot" ]; then
              echo "is_bot=true" >> $GITHUB_OUTPUT
              echo "should_process=false" >> $GITHUB_OUTPUT
              echo "Botã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ - å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—"
              exit 0
            fi
            
            # GitHub Actions Botã‹ãƒã‚§ãƒƒã‚¯
            if [ "$COMMENT_AUTHOR" = "github-actions[bot]" ] || [ "$COMMENT_AUTHOR" = "github-actions" ]; then
              echo "is_bot=true" >> $GITHUB_OUTPUT
              echo "should_process=false" >> $GITHUB_OUTPUT
              echo "GitHub Actions Botã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ - å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—"
              exit 0
            fi
            
            # Claude Code Actionã®ã‚³ãƒ¡ãƒ³ãƒˆã‹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
            if echo "$COMMENT_AUTHOR" | grep -qi "claude"; then
              echo "is_bot=true" >> $GITHUB_OUTPUT
              echo "should_process=false" >> $GITHUB_OUTPUT
              echo "Claudeãƒœãƒƒãƒˆã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ - å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—"
              exit 0
            fi
            
            echo "is_bot=false" >> $GITHUB_OUTPUT
            echo "should_process=true" >> $GITHUB_OUTPUT
            echo "äººé–“ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ - å‡¦ç†ã‚’ç¶™ç¶š"
          fi

      # Bot ãƒã‚§ãƒƒã‚¯ã§å‡¦ç†ä¸è¦ã¨åˆ¤å®šã•ã‚ŒãŸå ´åˆã¯çµ‚äº†
      - name: Skip if bot comment
        if: steps.bot-check.outputs.should_process == 'false'
        run: |
          echo "ğŸ¤– Botã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã¾ãŸã¯è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
          echo "ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆè€…: ${{ github.event.comment.user.login }}"
          echo "ã‚¹ã‚­ãƒƒãƒ—ç†ç”±: Bot ã¾ãŸã¯ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„"
          exit 0

      - name: Checkout repository
        if: steps.bot-check.outputs.should_process == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # GitHub Token ã®æ¤œè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 
      - name: Verify GitHub Token
        if: steps.bot-check.outputs.should_process == 'true'
        id: verify-token
        run: |
          echo "=== GitHub Token æ¤œè¨¼ ==="
          
          # GITHUB_TOKENã®æ¨©é™ã‚’ãƒ†ã‚¹ãƒˆ
          REPO_CHECK=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}")
          
          echo "ãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ: HTTP $REPO_CHECK"
          
          if [ "$REPO_CHECK" = "200" ]; then
            echo "github_token_valid=true" >> $GITHUB_OUTPUT
            echo "âœ… GitHub Token æ¤œè¨¼æˆåŠŸ"
          else
            echo "github_token_valid=false" >> $GITHUB_OUTPUT
            echo "âŒ GitHub Token æ¤œè¨¼å¤±æ•—"
          fi

      - name: Parse Issue Information
        if: steps.bot-check.outputs.should_process == 'true'
        id: parse-issue
        run: |
          echo "=== Issueæƒ…å ±è§£æ ==="

          # Issueæƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
          if [ "${{ github.event_name }}" = "issues" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
            ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
            ISSUE_LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
            EVENT_TYPE="issue_created"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
            ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
            ISSUE_LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
            EVENT_TYPE="comment_created"
          fi

          # å‡ºåŠ›å¤‰æ•°ã«è¨­å®š
          echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
          echo "issue_title=${ISSUE_TITLE}" >> $GITHUB_OUTPUT
          echo "issue_author=${ISSUE_AUTHOR}" >> $GITHUB_OUTPUT
          echo "issue_labels=${ISSUE_LABELS}" >> $GITHUB_OUTPUT
          echo "event_type=${EVENT_TYPE}" >> $GITHUB_OUTPUT

          # Issueæœ¬æ–‡ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆç‰¹æ®Šæ–‡å­—å¯¾å¿œï¼‰
          cat > issue_body.txt << 'EOF'
${{ github.event.issue.body }}
EOF

          # ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯ä¿å­˜
          if [ -n "${COMMENT_BODY:-}" ]; then
            cat > comment_body.txt << 'EOF'
${{ github.event.comment.body }}
EOF
            echo "has_comment=true" >> $GITHUB_OUTPUT
            echo "comment_author=${COMMENT_AUTHOR}" >> $GITHUB_OUTPUT
          else
            echo "has_comment=false" >> $GITHUB_OUTPUT
          fi

          echo "Issue #${ISSUE_NUMBER} ã®æƒ…å ±ã‚’è§£æå®Œäº† (ã‚¤ãƒ™ãƒ³ãƒˆ: ${EVENT_TYPE})"

      - name: Categorize Issue
        if: steps.bot-check.outputs.should_process == 'true'
        id: categorize
        run: |
          echo "=== Issueåˆ†é¡ ==="

          TITLE="${{ steps.parse-issue.outputs.issue_title }}"
          LABELS="${{ steps.parse-issue.outputs.issue_labels }}"
          EVENT_TYPE="${{ steps.parse-issue.outputs.event_type }}"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å†…å®¹ã‚’èª­ã¿è¾¼ã¿
          if [ -f issue_body.txt ]; then
            BODY=$(cat issue_body.txt)
          else
            BODY=""
          fi

          # ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯è¿½åŠ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ä½¿ç”¨
          if [ "${{ steps.parse-issue.outputs.has_comment }}" = "true" ] && [ -f comment_body.txt ]; then
            COMMENT_BODY=$(cat comment_body.txt)
            BODY="${BODY}\n\n=== è¿½åŠ ã‚³ãƒ¡ãƒ³ãƒˆ ===\n${COMMENT_BODY}"
          fi

          # åˆ†é¡ãƒ­ã‚¸ãƒƒã‚¯
          CATEGORY="general"
          PRIORITY="medium"

          # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹å„ªå…ˆåº¦èª¿æ•´
          if [ "$EVENT_TYPE" = "comment_created" ]; then
            echo "ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ã«ã‚ˆã‚‹å†åˆ†æ"
            PRIORITY="low"
          fi

          # ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ©ãƒ™ãƒ«ã«ã‚ˆã‚‹åˆ†é¡ãƒ­ã‚¸ãƒƒã‚¯
          if echo "$TITLE" | grep -qi "ãƒã‚°\|ã‚¨ãƒ©ãƒ¼\|ä¸å…·åˆ\|bug\|error"; then
            CATEGORY="bug"
            PRIORITY="high"
          elif echo "$TITLE" | grep -qi "æ©Ÿèƒ½\|è¦æœ›\|enhancement\|feature"; then
            CATEGORY="enhancement"
            PRIORITY="medium"
          elif echo "$TITLE" | grep -qi "ãƒ˜ãƒ«ãƒ—\|ã‚µãƒãƒ¼ãƒˆ\|ä½¿ã„æ–¹\|help\|support"; then
            CATEGORY="support"
            PRIORITY="medium"
          elif echo "$TITLE" | grep -qi "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£\|security"; then
            CATEGORY="security"
            PRIORITY="critical"
          elif echo "$TITLE" | grep -qi "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹\|performance\|é…ã„\|slow"; then
            CATEGORY="performance"
            PRIORITY="high"
          fi

          # ãƒ©ãƒ™ãƒ«ã«ã‚ˆã‚‹åˆ†é¡ï¼ˆå„ªå…ˆï¼‰
          if echo "$LABELS" | grep -qi "bug"; then
            CATEGORY="bug"
          elif echo "$LABELS" | grep -qi "enhancement"; then
            CATEGORY="enhancement"
          elif echo "$LABELS" | grep -qi "support"; then
            CATEGORY="support"
          elif echo "$LABELS" | grep -qi "security"; then
            CATEGORY="security"
            PRIORITY="critical"
          fi

          echo "category=${CATEGORY}" >> $GITHUB_OUTPUT
          echo "priority=${PRIORITY}" >> $GITHUB_OUTPUT
          echo "åˆ†é¡: ${CATEGORY}, å„ªå…ˆåº¦: ${PRIORITY} (ã‚¤ãƒ™ãƒ³ãƒˆ: ${EVENT_TYPE})"

      - name: Create Claude Analysis Prompt
        if: steps.bot-check.outputs.should_process == 'true'
        id: create-prompt
        run: |
          echo "=== Claudeåˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ ==="

          CATEGORY="${{ steps.categorize.outputs.category }}"
          PRIORITY="${{ steps.categorize.outputs.priority }}"
          ISSUE_NUMBER="${{ steps.parse-issue.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.parse-issue.outputs.issue_title }}"
          ISSUE_AUTHOR="${{ steps.parse-issue.outputs.issue_author }}"
          EVENT_TYPE="${{ steps.parse-issue.outputs.event_type }}"

          # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´
          if [ "$EVENT_TYPE" = "comment_created" ]; then
            PROMPT_PREFIX="è¿½åŠ ã‚³ãƒ¡ãƒ³ãƒˆã«å¯¾ã™ã‚‹æŠ€è¡“ã‚µãƒãƒ¼ãƒˆåˆ†æ"
            CONTEXT_NOTE="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è¿½åŠ ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸã€‚å…ƒã®Issueã¨åˆã‚ã›ã¦åŒ…æ‹¬çš„ã«åˆ†æã—ã¦ãã ã•ã„ã€‚"
          else
            PROMPT_PREFIX="æ–°è¦IssueæŠ€è¡“ã‚µãƒãƒ¼ãƒˆåˆ†æ"
            CONTEXT_NOTE="æ–°ã—ãIssueãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ãªæŠ€è¡“åˆ†æã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"
          fi

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          cat > claude_prompt.txt << 'EOF'
# å£è…”æ©Ÿèƒ½ä½ä¸‹ç—‡è¨ºæ–­ãƒ»ç®¡ç†ã‚¢ãƒ—ãƒª - æŠ€è¡“ã‚µãƒãƒ¼ãƒˆåˆ†æ

## æ‹…å½“AI
ã‚ãªãŸã¯å£è…”æ©Ÿèƒ½ä½ä¸‹ç—‡è¨ºæ–­ãƒ»ç®¡ç†ã‚¢ãƒ—ãƒªã®ä¸Šç´šæŠ€è¡“ã‚µãƒãƒ¼ãƒˆAIã§ã™ã€‚

## å•ã„åˆã‚ã›æƒ…å ±
EOF

          # å¤‰æ•°ã‚’è¿½åŠ 
          echo "- **Issueç•ªå·**: #${ISSUE_NUMBER}" >> claude_prompt.txt
          echo "- **ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—**: ${EVENT_TYPE}" >> claude_prompt.txt
          echo "- **ã‚«ãƒ†ã‚´ãƒª**: ${CATEGORY}" >> claude_prompt.txt
          echo "- **å„ªå…ˆåº¦**: ${PRIORITY}" >> claude_prompt.txt
          echo "- **å ±å‘Šè€…**: ${ISSUE_AUTHOR}" >> claude_prompt.txt
          echo "- **ã‚¿ã‚¤ãƒˆãƒ«**: ${ISSUE_TITLE}" >> claude_prompt.txt
          echo "" >> claude_prompt.txt
          echo "### è©³ç´°å†…å®¹" >> claude_prompt.txt

          # Issueæœ¬æ–‡ã‚’è¿½åŠ 
          if [ -f issue_body.txt ]; then
            cat issue_body.txt >> claude_prompt.txt
          fi

          if [ "${{ steps.parse-issue.outputs.has_comment }}" = "true" ] && [ -f comment_body.txt ]; then
            echo "" >> claude_prompt.txt
            echo "### è¿½åŠ ã‚³ãƒ¡ãƒ³ãƒˆ" >> claude_prompt.txt
            echo "- **ã‚³ãƒ¡ãƒ³ãƒˆè€…**: ${{ steps.parse-issue.outputs.comment_author }}" >> claude_prompt.txt
            cat comment_body.txt >> claude_prompt.txt
          fi

          # æŠ€è¡“æƒ…å ±ã¨æŒ‡ç¤ºã‚’è¿½åŠ 
          cat >> claude_prompt.txt << 'EOF'

## ã‚¢ãƒ—ãƒªæŠ€è¡“æƒ…å ±
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: HTML5, CSS3, JavaScript (ES6+)
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Firebase Firestore + ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
- **èªè¨¼**: Google OAuth 2.0 (Firebase Authentication)
- **UI**: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
- **å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶**: Chrome, Firefox, Safari, Edge (æœ€æ–°ç‰ˆ)

## ä¸»è¦æ©Ÿèƒ½ã¨ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
- **æ‚£è€…ç®¡ç†**: patients.js
- **æ¤œæŸ»æ©Ÿèƒ½**: assessment.js
- **ç®¡ç†è¨ˆç”»**: management.js
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: database.js (Firebaseç‰ˆ)
- **èªè¨¼**: firebase-config.js
- **ãƒ¡ã‚¤ãƒ³**: app.js, index.html
- **ã‚¹ã‚¿ã‚¤ãƒ«**: styles.css

## æŒ‡ç¤º
ä»¥ä¸‹ã®å½¢å¼ã§åŒ…æ‹¬çš„ãªæŠ€è¡“ã‚µãƒãƒ¼ãƒˆå¿œç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

1. **å•é¡Œåˆ†æ**: æŠ€è¡“çš„ãªåŸå› ã¨å½±éŸ¿ç¯„å›²
2. **å³åº§ã®å¯¾å¿œæ‰‹é †**: 3ã¤ã®å…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—
3. **æŠ€è¡“çš„è§£æ±ºç­–**: è©³ç´°ãªè§£æ±ºæ–¹æ³•
4. **ãƒ†ã‚¹ãƒˆæ‰‹é †**: æ¤œè¨¼æ–¹æ³•
5. **å†ç™ºé˜²æ­¢ç­–**: ä»Šå¾Œã®äºˆé˜²ç­–

åŒ»ç™‚å¾“äº‹è€…å‘ã‘ã‚¢ãƒ—ãƒªã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨æ€§ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã‚’æœ€å„ªå…ˆã«è€ƒæ…®ã—ã¦ãã ã•ã„ã€‚

âš ï¸ é‡è¦ï¼šã“ã®å¿œç­”ã¯è‡ªå‹•ç”Ÿæˆã§ã‚ã‚‹ã“ã¨ã‚’æ˜è¨˜ã—ã€ã€Œã“ã®å¿œç­”ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€ã¨ã„ã†æ–‡è¨€ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚
EOF

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’GITHUB_OUTPUTç”¨ã«æº–å‚™
          {
            echo 'claude_prompt<<EOF'
            cat claude_prompt.txt
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          echo "Claudeåˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆå®Œäº† (ã‚¤ãƒ™ãƒ³ãƒˆ: ${EVENT_TYPE})"

      - name: Run Claude Code Analysis
        if: steps.bot-check.outputs.should_process == 'true' && steps.verify-token.outputs.github_token_valid == 'true'
        continue-on-error: true
        uses: anthropics/claude-code-action@beta
        id: claude-analysis
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: ${{ steps.create-prompt.outputs.claude_prompt }}
          trigger_phrase: ".*"
          custom_instructions: "Issue #${{ steps.parse-issue.outputs.issue_number }}ã®æŠ€è¡“ã‚µãƒãƒ¼ãƒˆåˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚å¿…ãšã€Œã“ã®å¿œç­”ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€ã¨ã„ã†æ–‡è¨€ã‚’å«ã‚ã¦ãã ã•ã„ã€‚"
          mode: tag
          branch_prefix: claude/
          use_bedrock: false
          use_vertex: false
          timeout_minutes: 10
          use_sticky_comment: false
          use_commit_signing: false

      - name: Create Fallback Response
        if: steps.bot-check.outputs.should_process == 'true'
        id: fallback-response
        run: |
          echo "=== ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ä½œæˆ ==="

          CATEGORY="${{ steps.categorize.outputs.category }}"
          PRIORITY="${{ steps.categorize.outputs.priority }}"
          ISSUE_AUTHOR="${{ steps.parse-issue.outputs.issue_author }}"
          EVENT_TYPE="${{ steps.parse-issue.outputs.event_type }}"
          TOKEN_VALID="${{ steps.verify-token.outputs.github_token_valid }}"

          # ãƒˆãƒ¼ã‚¯ãƒ³å•é¡ŒãŒã‚ã‚‹å ´åˆã®ç‰¹åˆ¥å¯¾å¿œ
          if [ "$TOKEN_VALID" = "false" ]; then
            TECHNICAL_NOTE="ç¾åœ¨ã€è‡ªå‹•åˆ†æã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚æ‰‹å‹•ã§è©³ç´°åˆ†æã‚’å®Ÿæ–½ã„ãŸã—ã¾ã™ã€‚"
          else
            TECHNICAL_NOTE="æŠ€è¡“ã‚µãƒãƒ¼ãƒˆãƒãƒ¼ãƒ ãŒè©³ç´°åˆ†æã‚’å®Ÿæ–½ã—ã€é©åˆ‡ãªè§£æ±ºç­–ã‚’ã”ææ¡ˆã„ãŸã—ã¾ã™ã€‚"
          fi

          # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª¿æ•´
          if [ "$EVENT_TYPE" = "comment_created" ]; then
            GREETING="è¿½åŠ ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼"
            ACTION_MESSAGE="è¿½åŠ ã„ãŸã ã„ãŸæƒ…å ±ã‚’è¸ã¾ãˆã¦ã€è©³ç´°ãªåˆ†æã‚’è¡Œã„ã¾ã™ã€‚"
          else
            GREETING="ãŠå•ã„åˆã‚ã›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼"
            ACTION_MESSAGE="è©³ç´°ãªæŠ€è¡“åˆ†æã‚’é–‹å§‹ã—ã¦ãŠã‚Šã€24æ™‚é–“ä»¥å†…ã«å…·ä½“çš„ãªè§£æ±ºç­–ã‚’ãŠè¿”ã—ã„ãŸã—ã¾ã™ã€‚"
          fi

          # ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®çµµæ–‡å­—ã¨ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
          case "$CATEGORY" in
            "bug")
              EMOJI="ğŸ›"
              TITLE="ãƒã‚°å ±å‘Šã®ç¢ºèª"
              PRIORITY_BADGE="ğŸ”¥ é«˜"
              ;;
            "enhancement")
              EMOJI="âœ¨"
              TITLE="æ©Ÿèƒ½è¦æœ›ã®ç¢ºèª"
              PRIORITY_BADGE="ğŸ“‹ ä¸­"
              ;;
            "support")
              EMOJI="ğŸ’¬"
              TITLE="ã‚µãƒãƒ¼ãƒˆä¾é ¼ã®ç¢ºèª"
              PRIORITY_BADGE="ğŸ’¡ ä¸­"
              ;;
            "security")
              EMOJI="ğŸ”’"
              TITLE="ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®ç¢ºèª"
              PRIORITY_BADGE="âš¡ ç·Šæ€¥"
              ;;
            "performance")
              EMOJI="âš¡"
              TITLE="ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã®ç¢ºèª"
              PRIORITY_BADGE="ğŸ”¥ é«˜"
              ;;
            *)
              EMOJI="ğŸ“‹"
              TITLE="ãŠå•ã„åˆã‚ã›ã®ç¢ºèª"
              PRIORITY_BADGE="ğŸ“‹ ä¸­"
              ;;
          esac

          # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã‚’ä½œæˆ
          cat > fallback_response.md << EOF
## ${EMOJI} ${TITLE}

${ISSUE_AUTHOR}ã•ã‚“ã€${GREETING}

${ACTION_MESSAGE}

**å„ªå…ˆåº¦**: ${PRIORITY_BADGE} | **äºˆæƒ³å¯¾å¿œæ™‚é–“**: 24æ™‚é–“ä»¥å†…

---

### ğŸ” è‡ªå‹•åˆ†æçµæœ

ãŠå•ã„åˆã‚ã›å†…å®¹ã‚’ç¢ºèªã„ãŸã—ã¾ã—ãŸã€‚${TECHNICAL_NOTE}

### ğŸš€ å³åº§ã®å¯¾å¿œæ‰‹é †

å•é¡Œã®è©³ç´°ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã‚’ãŠè©¦ã—ãã ã•ã„ï¼š

1. **ãƒ–ãƒ©ã‚¦ã‚¶ã®å†èª­ã¿è¾¼ã¿**: Ctrl+F5ï¼ˆWindowsï¼‰ã¾ãŸã¯Cmd+Shift+Rï¼ˆMacï¼‰ã§å¼·åˆ¶æ›´æ–°
2. **é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ç¢ºèª**: F12ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦Consoleã‚¿ãƒ–ã§ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
3. **åˆ¥ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®æ¤œè¨¼**: Chromeã€Firefoxã€Safariãªã©åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§åŒæ§˜ã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã‹ç¢ºèª

---

<sub>âš ï¸ ã“ã®å¿œç­”ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚æŠ€è¡“ã‚µãƒãƒ¼ãƒˆãƒãƒ¼ãƒ ãŒè©³ç´°åˆ†æã‚’è¡Œã„ã€24æ™‚é–“ä»¥å†…ã«è¿½åŠ å›ç­”ã„ãŸã—ã¾ã™ã€‚</sub>
EOF

          echo "response_file=fallback_response.md" >> $GITHUB_OUTPUT
          echo "ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ä½œæˆå®Œäº†"

      - name: Check Claude Analysis Result
        if: steps.bot-check.outputs.should_process == 'true'
        id: check-claude
        run: |
          echo "=== Claude Codeçµæœãƒã‚§ãƒƒã‚¯ ==="

          CLAUDE_SUCCESS="${{ steps.claude-analysis.outcome }}"
          echo "Claude Code ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœ: $CLAUDE_SUCCESS"

          if [ "$CLAUDE_SUCCESS" = "success" ]; then
            echo "claude_available=true" >> $GITHUB_OUTPUT
            echo "Claude Code ã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ã¾ã—ãŸ"
          else
            echo "claude_available=false" >> $GITHUB_OUTPUT
            echo "Claude Code ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          fi

      - name: Save Claude Response
        if: steps.bot-check.outputs.should_process == 'true' && steps.check-claude.outputs.claude_available == 'true'
        id: save-claude
        run: |
          echo "=== Claudeå¿œç­”ä¿å­˜ ==="

          # Claudeå¿œç­”ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          cat > claude_response.txt << 'EOF'
${{ steps.claude-analysis.outputs.response }}
EOF

          # å¿œç­”ãŒç©ºã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
          if [ -s claude_response.txt ]; then
            RESPONSE_LENGTH=$(wc -c < claude_response.txt)
            echo "Claudeå¿œç­”ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸ (ã‚µã‚¤ã‚º: ${RESPONSE_LENGTH} bytes)"
            echo "saved=true" >> $GITHUB_OUTPUT
          else
            echo "Claudeå¿œç­”ãŒç©ºã§ã™"
            echo "saved=false" >> $GITHUB_OUTPUT
          fi

      - name: Format Claude Response
        if: steps.bot-check.outputs.should_process == 'true' && steps.save-claude.outputs.saved == 'true'
        id: format-claude
        run: |
          echo "=== Claudeå¿œç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ==="

          # ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¿œç­”ã‚’èª­ã¿è¾¼ã¿
          CLAUDE_RESPONSE=$(cat claude_response.txt)
          echo "Claude Code å¿œç­”ã®é•·ã•: ${#CLAUDE_RESPONSE}"

          # å¿œç­”ãŒç©ºã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
          if [ -n "$CLAUDE_RESPONSE" ] && [ "$CLAUDE_RESPONSE" != "null" ] && [ "$CLAUDE_RESPONSE" != "" ]; then
            echo "Claude Codeå¿œç­”ã‚’ä½¿ç”¨"
            
            # è‡ªå‹•ç”Ÿæˆã®æ–‡è¨€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if ! echo "$CLAUDE_RESPONSE" | grep -q "è‡ªå‹•ç”Ÿæˆ"; then
              # å«ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯è¿½åŠ 
              echo "$CLAUDE_RESPONSE" > temp_response.md
              echo "" >> temp_response.md
              echo "---" >> temp_response.md
              echo "<sub>âš ï¸ ã“ã®å¿œç­”ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚</sub>" >> temp_response.md
              cp temp_response.md final_response.md
            else
              echo "$CLAUDE_RESPONSE" > final_response.md
            fi
            
            echo "response_file=final_response.md" >> $GITHUB_OUTPUT
            echo "source=claude" >> $GITHUB_OUTPUT
            echo "formatted=true" >> $GITHUB_OUTPUT
          else
            echo "Claudeå¿œç­”ãŒç©ºã®ãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨"
            echo "formatted=false" >> $GITHUB_OUTPUT
          fi

      - name: Format GitHub Response
        if: steps.bot-check.outputs.should_process == 'true'
        id: format-response
        run: |
          echo "=== GitHubå¿œç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ==="

          # Claudeå¿œç­”ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
          if [ "${{ steps.format-claude.outputs.formatted }}" = "true" ]; then
            echo "Claude Codeå¿œç­”ã‚’ä½¿ç”¨"
            echo "response_file=final_response.md" >> $GITHUB_OUTPUT
            echo "source=claude" >> $GITHUB_OUTPUT
          else
            echo "ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã‚’ä½¿ç”¨"
            echo "ç†ç”±: Claude Code ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ã—ãŸã‹ã€å¿œç­”ãŒç©ºã§ã™"
            cp fallback_response.md final_response.md
            echo "response_file=final_response.md" >> $GITHUB_OUTPUT
            echo "source=fallback" >> $GITHUB_OUTPUT
          fi

          echo "GitHubå¿œç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Œäº†"

      - name: Post Response to GitHub
        if: steps.bot-check.outputs.should_process == 'true'
        run: |
          echo "=== GitHubå¿œç­”æŠ•ç¨¿ ==="

          # å¿œç­”å†…å®¹ã‚’JSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦æŠ•ç¨¿
          RESPONSE_BODY=$(cat final_response.md | jq -Rs .)
          RESPONSE_SOURCE="${{ steps.format-response.outputs.source || 'unknown' }}"

          echo "å¿œç­”ã‚½ãƒ¼ã‚¹: $RESPONSE_SOURCE"

          # GitHubã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
          HTTP_STATUS=$(curl -w "%{http_code}" -s -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ steps.parse-issue.outputs.issue_number }}/comments" \
            -d "{\"body\": $RESPONSE_BODY}" \
            -o response_output.txt)

          echo "HTTP Status: $HTTP_STATUS"

          if [ "$HTTP_STATUS" = "201" ]; then
            echo "âœ… GitHubå¿œç­”æŠ•ç¨¿æˆåŠŸ"
          else
            echo "âŒ GitHubå¿œç­”æŠ•ç¨¿å¤±æ•—"
            cat response_output.txt
            exit 1
          fi

      - name: Update Issue Labels
        if: steps.bot-check.outputs.should_process == 'true' && steps.parse-issue.outputs.event_type == 'issue_created'
        run: |
          echo "=== Issue ãƒ©ãƒ™ãƒ«æ›´æ–° ==="

          # æ–°è¦Issueä½œæˆæ™‚ã®ã¿ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
          # ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ æ™‚ã¯ãƒ©ãƒ™ãƒ«æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—

          CATEGORY="${{ steps.categorize.outputs.category }}"
          PRIORITY="${{ steps.categorize.outputs.priority }}"

          # ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸãƒ©ãƒ™ãƒ«è¨­å®š
          LABELS_TO_ADD=""
          case "$CATEGORY" in
            "bug")
              LABELS_TO_ADD='["bug", "needs-investigation"]'
              ;;
            "enhancement")
              LABELS_TO_ADD='["enhancement", "needs-review"]'
              ;;
            "support")
              LABELS_TO_ADD='["support", "needs-response"]'
              ;;
            "security")
              LABELS_TO_ADD='["security", "priority-high"]'
              ;;
            "performance")
              LABELS_TO_ADD='["performance", "needs-investigation"]'
              ;;
            *)
              LABELS_TO_ADD='["needs-triage"]'
              ;;
          esac

          # ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          HTTP_STATUS=$(curl -w "%{http_code}" -s -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ steps.parse-issue.outputs.issue_number }}/labels" \
            -d "{\"labels\": $LABELS_TO_ADD}" \
            -o label_output.txt)

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… ãƒ©ãƒ™ãƒ«æ›´æ–°å®Œäº†: $LABELS_TO_ADD"
          else
            echo "âŒ ãƒ©ãƒ™ãƒ«æ›´æ–°å¤±æ•—"
            cat label_output.txt
          fi

      - name: Cleanup
        if: always()
        run: |
          echo "=== ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ==="
          rm -f issue_body.txt comment_body.txt claude_prompt.txt
          rm -f fallback_response.md final_response.md temp_response.md
          rm -f claude_response.txt response_output.txt label_output.txt
          echo "ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤å®Œäº†"