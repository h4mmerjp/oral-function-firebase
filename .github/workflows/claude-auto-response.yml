# .github/workflows/claude-auto-response.yml
name: Claude Code Auto Response

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  claude-auto-response:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Issue Information
        id: parse-issue
        run: |
          echo "=== Issueæƒ…å ±è§£æ ==="

          # Issueæƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
          if [ "${{ github.event_name }}" = "issues" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
            ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
            ISSUE_LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
            ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
            ISSUE_LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          fi

          # å‡ºåŠ›å¤‰æ•°ã«è¨­å®š
          echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
          echo "issue_title=${ISSUE_TITLE}" >> $GITHUB_OUTPUT
          echo "issue_author=${ISSUE_AUTHOR}" >> $GITHUB_OUTPUT
          echo "issue_labels=${ISSUE_LABELS}" >> $GITHUB_OUTPUT

          # Issueæœ¬æ–‡ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆç‰¹æ®Šæ–‡å­—å¯¾å¿œï¼‰
          echo "${ISSUE_BODY}" > issue_body.txt

          # ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯ä¿å­˜
          if [ -n "${COMMENT_BODY:-}" ]; then
            echo "${COMMENT_BODY}" > comment_body.txt
            echo "has_comment=true" >> $GITHUB_OUTPUT
            echo "comment_author=${COMMENT_AUTHOR}" >> $GITHUB_OUTPUT
          else
            echo "has_comment=false" >> $GITHUB_OUTPUT
          fi

          echo "Issue #${ISSUE_NUMBER} ã®æƒ…å ±ã‚’è§£æå®Œäº†"

      - name: Categorize Issue
        id: categorize
        run: |
          echo "=== Issueåˆ†é¡ ==="

          TITLE="${{ steps.parse-issue.outputs.issue_title }}"
          LABELS="${{ steps.parse-issue.outputs.issue_labels }}"
          BODY=$(cat issue_body.txt)

          # åˆ†é¡ãƒ­ã‚¸ãƒƒã‚¯
          CATEGORY="general"
          PRIORITY="medium"

          # ãƒ©ãƒ™ãƒ«ãƒ™ãƒ¼ã‚¹ã®åˆ†é¡
          if echo "${LABELS}" | grep -q "bug"; then
            CATEGORY="bug"
            PRIORITY="high"
          elif echo "${LABELS}" | grep -q "enhancement"; then
            CATEGORY="feature"
            PRIORITY="medium"
          elif echo "${LABELS}" | grep -q "question"; then
            CATEGORY="question"
            PRIORITY="low"
          elif echo "${LABELS}" | grep -q "authentication"; then
            CATEGORY="auth"
            PRIORITY="high"
          elif echo "${LABELS}" | grep -q "performance"; then
            CATEGORY="performance"
            PRIORITY="high"
          fi

          # ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ãƒ™ãƒ¼ã‚¹ã®åˆ†é¡ï¼ˆãƒ©ãƒ™ãƒ«ãŒãªã„å ´åˆï¼‰
          TEXT_ALL="${TITLE} ${BODY}"

          if echo "${TEXT_ALL}" | grep -qi "ãƒã‚°\|bug\|ã‚¨ãƒ©ãƒ¼\|error\|å‹•ã‹ãªã„\|å•é¡Œ\|ä¸å…·åˆ\|å¤±æ•—\|ã§ããªã„"; then
            if [ "$CATEGORY" = "general" ]; then
              CATEGORY="bug"
              PRIORITY="high"
            fi
          elif echo "${TEXT_ALL}" | grep -qi "æ©Ÿèƒ½\|feature\|è¿½åŠ \|æ”¹å–„\|enhancement\|è¦æœ›\|ã»ã—ã„\|ã§ãã‚‹ã‚ˆã†ã«"; then
            if [ "$CATEGORY" = "general" ]; then
              CATEGORY="feature"
              PRIORITY="medium"
            fi
          elif echo "${TEXT_ALL}" | grep -qi "è³ªå•\|question\|ä½¿ã„æ–¹\|how\|æ•™ãˆã¦\|help\|ã‚ã‹ã‚‰ãªã„\|æ–¹æ³•"; then
            if [ "$CATEGORY" = "general" ]; then
              CATEGORY="question"
              PRIORITY="low"
            fi
          elif echo "${TEXT_ALL}" | grep -qi "ãƒ­ã‚°ã‚¤ãƒ³\|login\|èªè¨¼\|auth\|google\|firebase\|ã‚µã‚¤ãƒ³ã‚¤ãƒ³"; then
            if [ "$CATEGORY" = "general" ]; then
              CATEGORY="auth"
              PRIORITY="high"
            fi
          elif echo "${TEXT_ALL}" | grep -qi "é…ã„\|é‡ã„\|performance\|ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹\|é€Ÿåº¦\|ãƒ¬ã‚¹ãƒãƒ³ã‚¹"; then
            if [ "$CATEGORY" = "general" ]; then
              CATEGORY="performance"
              PRIORITY="high"
            fi
          fi

          # ç·Šæ€¥åº¦åˆ¤å®š
          if echo "${TEXT_ALL}" | grep -qi "ç·Šæ€¥\|urgent\|emergency\|ãƒ‡ãƒ¼ã‚¿\|æ¶ˆãˆ\|å‰Šé™¤\|å£Šã‚Œ\|ä½¿ãˆãªã„"; then
            PRIORITY="critical"
          fi

          echo "category=${CATEGORY}" >> $GITHUB_OUTPUT
          echo "priority=${PRIORITY}" >> $GITHUB_OUTPUT

          echo "åˆ†é¡: ${CATEGORY}, å„ªå…ˆåº¦: ${PRIORITY}"

      - name: Generate Claude Code Response
        id: claude-response
        run: |
          echo "=== Claude Codeå¿œç­”ç”Ÿæˆ ==="

          CATEGORY="${{ steps.categorize.outputs.category }}"
          PRIORITY="${{ steps.categorize.outputs.priority }}"
          ISSUE_NUMBER="${{ steps.parse-issue.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.parse-issue.outputs.issue_title }}"
          ISSUE_AUTHOR="${{ steps.parse-issue.outputs.issue_author }}"

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
          cat > claude_prompt.md << 'PROMPT_EOF'
          # å£è…”æ©Ÿèƒ½ä½ä¸‹ç—‡è¨ºæ–­ãƒ»ç®¡ç†ã‚¢ãƒ—ãƒª - æŠ€è¡“ã‚µãƒãƒ¼ãƒˆåˆ†æ

          ## æ‹…å½“AI
          ã‚ãªãŸã¯å£è…”æ©Ÿèƒ½ä½ä¸‹ç—‡è¨ºæ–­ãƒ»ç®¡ç†ã‚¢ãƒ—ãƒªã®ä¸Šç´šæŠ€è¡“ã‚µãƒãƒ¼ãƒˆAIã§ã™ã€‚

          ## å•ã„åˆã‚ã›æƒ…å ±
          PROMPT_EOF

          echo "- **Issueç•ªå·**: #${ISSUE_NUMBER}" >> claude_prompt.md
          echo "- **ã‚«ãƒ†ã‚´ãƒª**: ${CATEGORY}" >> claude_prompt.md
          echo "- **å„ªå…ˆåº¦**: ${PRIORITY}" >> claude_prompt.md
          echo "- **å ±å‘Šè€…**: ${ISSUE_AUTHOR}" >> claude_prompt.md
          echo "- **ã‚¿ã‚¤ãƒˆãƒ«**: ${ISSUE_TITLE}" >> claude_prompt.md
          echo "" >> claude_prompt.md
          echo "### è©³ç´°å†…å®¹" >> claude_prompt.md
          cat issue_body.txt >> claude_prompt.md

          if [ "${{ steps.parse-issue.outputs.has_comment }}" = "true" ]; then
            echo "" >> claude_prompt.md
            echo "### è¿½åŠ ã‚³ãƒ¡ãƒ³ãƒˆ" >> claude_prompt.md
            echo "- **ã‚³ãƒ¡ãƒ³ãƒˆè€…**: ${{ steps.parse-issue.outputs.comment_author }}" >> claude_prompt.md
            cat comment_body.txt >> claude_prompt.md
          fi

          cat >> claude_prompt.md << 'PROMPT_EOF'

          ## ã‚¢ãƒ—ãƒªæŠ€è¡“æƒ…å ±
          - **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: HTML5, CSS3, JavaScript (ES6+)
          - **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Firebase Firestore + ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
          - **èªè¨¼**: Google OAuth 2.0 (Firebase Authentication)
          - **UI**: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
          - **å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶**: Chrome, Firefox, Safari, Edge (æœ€æ–°ç‰ˆ)

          ## ä¸»è¦æ©Ÿèƒ½ã¨ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
          - **æ‚£è€…ç®¡ç†**: patients.js
          - **æ¤œæŸ»æ©Ÿèƒ½**: assessment.js
          - **ç®¡ç†è¨ˆç”»**: management.js
          - **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: database.js (Firebaseç‰ˆ)
          - **èªè¨¼**: firebase-config.js
          - **ãƒ¡ã‚¤ãƒ³**: app.js, index.html
          - **ã‚¹ã‚¿ã‚¤ãƒ«**: styles.css

          ## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–
          1. **ãƒ­ã‚°ã‚¤ãƒ³å•é¡Œ**: Googleèªè¨¼è¨­å®šã€Cookieã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚«ãƒ¼
          2. **ãƒ‡ãƒ¼ã‚¿ä¿å­˜å•é¡Œ**: Firebaseæ¥ç¶šã€èªè¨¼çŠ¶æ…‹ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
          3. **æ‚£è€…æ•°åˆ¶é™**: ç„¡æ–™ãƒ—ãƒ©ãƒ³5äººã¾ã§ã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ç„¡åˆ¶é™
          4. **ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§**: æœ€æ–°ãƒ–ãƒ©ã‚¦ã‚¶æ¨å¥¨ã€å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯åˆ¶é™
          5. **ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ**: ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Šæ¨å¥¨ã€ã‚¹ãƒãƒ›ã¯æ“ä½œåˆ¶é™ã‚ã‚Š

          ## æŒ‡ç¤º
          ä»¥ä¸‹ã®å½¢å¼ã§åŒ…æ‹¬çš„ãªæŠ€è¡“ã‚µãƒãƒ¼ãƒˆå¿œç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

          ```json
          {
            "analysis": "å•é¡Œã®æŠ€è¡“çš„åˆ†æï¼ˆåŸå› ã€å½±éŸ¿ç¯„å›²ã€é–¢é€£ã‚·ã‚¹ãƒ†ãƒ ï¼‰",
            "category_specific_info": "ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®è©³ç´°æƒ…å ±ã‚„èƒŒæ™¯",
            "immediate_steps": ["ã™ãã«è©¦ã›ã‚‹è§£æ±ºæ‰‹é †1", "è§£æ±ºæ‰‹é †2", "è§£æ±ºæ‰‹é †3"],
            "technical_solution": "æŠ€è¡“çš„ãªè§£æ±ºæ–¹æ³•ã®è©³ç´°èª¬æ˜",
            "code_suggestions": [
              {
                "file": "å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«å",
                "change_type": "ä¿®æ­£|è¿½åŠ |å‰Šé™¤",
                "description": "å¤‰æ›´å†…å®¹ã®èª¬æ˜",
                "code": "å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰"
              }
            ],
            "testing_steps": ["ãƒ†ã‚¹ãƒˆæ‰‹é †1", "ãƒ†ã‚¹ãƒˆæ‰‹é †2", "ãƒ†ã‚¹ãƒˆæ‰‹é †3"],
            "prevention": "å†ç™ºé˜²æ­¢ç­–",
            "related_issues": "é–¢é€£ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å•é¡Œ",
            "estimated_time": "è§£æ±ºäºˆæƒ³æ™‚é–“",
            "difficulty": "easy|medium|hard",
            "follow_up": "ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ãŒå¿…è¦ãªé …ç›®"
          }
          ```

          åŒ»ç™‚å¾“äº‹è€…å‘ã‘ã‚¢ãƒ—ãƒªã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨æ€§ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã‚’æœ€å„ªå…ˆã«è€ƒæ…®ã—ã¦ãã ã•ã„ã€‚
          PROMPT_EOF

          echo "Claude Codeãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆå®Œäº†"

      - name: Run Claude Code Analysis
        uses: anthropics/claude-code-action@beta
        id: claude-analysis
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: claude_prompt.md
          include_repository: true
          include_diff: false

      - name: Process Claude Response
        id: process-response
        run: |
          echo "=== Claudeå¿œç­”å‡¦ç† ==="

          # Claude Codeã®å‡ºåŠ›ã‚’å–å¾—
          CLAUDE_OUTPUT="${{ steps.claude-analysis.outputs.response }}"

          # JSONéƒ¨åˆ†ã‚’æŠ½å‡º
          echo "${CLAUDE_OUTPUT}" > claude_raw_output.txt

          # JSONã®æŠ½å‡ºã‚’è©¦è¡Œ
          if echo "${CLAUDE_OUTPUT}" | grep -q "```json"; then
            # JSONãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰æŠ½å‡º
            echo "${CLAUDE_OUTPUT}" | sed -n '/```json/,/```/p' | sed '1d;$d' > claude_response.json
          elif echo "${CLAUDE_OUTPUT}" | grep -q "{"; then
            # JSONéƒ¨åˆ†ã‚’ç›´æ¥æŠ½å‡º
            echo "${CLAUDE_OUTPUT}" | grep -o '{.*}' | head -1 > claude_response.json
          else
            # JSONãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã‚’ç”Ÿæˆ
            cat > claude_response.json << 'FALLBACK_EOF'
          {
            "analysis": "Claude Codeåˆ†æã‚·ã‚¹ãƒ†ãƒ ã§ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§è©³ç´°åˆ†æã‚’è¡Œã„ã¾ã™ã€‚",
            "category_specific_info": "å•ã„åˆã‚ã›å†…å®¹ã‚’ç¢ºèªã—ã€é©åˆ‡ãªæŠ€è¡“ã‚µãƒãƒ¼ãƒˆã‚’æä¾›ã—ã¾ã™ã€‚",
            "immediate_steps": [
              "ãƒ–ãƒ©ã‚¦ã‚¶ã®å†èª­ã¿è¾¼ã¿ï¼ˆCtrl+F5ï¼‰ã‚’ãŠè©¦ã—ãã ã•ã„",
              "åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚åŒæ§˜ã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã‹ã”ç¢ºèªãã ã•ã„",
              "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§ç¢ºèªã—ã¦ãã ã•ã„"
            ],
            "technical_solution": "è©³ç´°ãªæŠ€è¡“åˆ†æã¯é–‹ç™ºãƒãƒ¼ãƒ ãŒæ‰‹å‹•ã§å®Ÿæ–½ã—ã€24æ™‚é–“ä»¥å†…ã«å›ç­”ã„ãŸã—ã¾ã™ã€‚",
            "code_suggestions": [],
            "testing_steps": [
              "å•é¡Œã®å†ç¾æ‰‹é †ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„",
              "ä½¿ç”¨ç’°å¢ƒï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã€OSã€ãƒ‡ãƒã‚¤ã‚¹ï¼‰ã‚’ãŠçŸ¥ã‚‰ã›ãã ã•ã„",
              "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å…·ä½“çš„ãªæ“ä½œã‚’è©³ç´°ã«æ•™ãˆã¦ãã ã•ã„"
            ],
            "prevention": "ä»Šå¾Œã®é¡ä¼¼å•é¡Œé˜²æ­¢ã®ãŸã‚ã€æ“ä½œæ‰‹é †ã®è¨˜éŒ²ã¨ç’°å¢ƒæƒ…å ±ã®å…±æœ‰ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚",
            "related_issues": "é¡ä¼¼å•é¡Œã®æ¤œç´¢ã¯éå»ã®Issueã‚’ã”ç¢ºèªãã ã•ã„ã€‚",
            "estimated_time": "24-48æ™‚é–“",
            "difficulty": "medium",
            "follow_up": "è©³ç´°åˆ†æå¾Œã«è¿½åŠ ã®è³ªå•ã‚„ç¢ºèªäº‹é …ã‚’ãŠé€ã‚Šã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
          }
          FALLBACK_EOF
          fi

          # JSONæ¤œè¨¼
          if ! python3 -m json.tool claude_response.json > /dev/null 2>&1; then
            echo "âš ï¸ JSONå½¢å¼ãŒç„¡åŠ¹ã®ãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã‚’ä½¿ç”¨"
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã‚’å†ç”Ÿæˆ
            cat > claude_response.json << 'FALLBACK2_EOF'
          {
            "analysis": "è‡ªå‹•åˆ†æã‚·ã‚¹ãƒ†ãƒ ã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ‰‹å‹•åˆ†æã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚",
            "immediate_steps": ["ãƒ–ãƒ©ã‚¦ã‚¶å†èª­ã¿è¾¼ã¿", "é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ç¢ºèª", "åˆ¥ãƒ–ãƒ©ã‚¦ã‚¶ã§æ¤œè¨¼"],
            "technical_solution": "é–‹ç™ºãƒãƒ¼ãƒ ãŒæ‰‹å‹•ã§åˆ†æã—ã€24æ™‚é–“ä»¥å†…ã«è©³ç´°å›ç­”ã—ã¾ã™ã€‚",
            "estimated_time": "24æ™‚é–“ä»¥å†…",
            "difficulty": "medium"
          }
          FALLBACK2_EOF
          fi

          echo "Claudeå¿œç­”å‡¦ç†å®Œäº†"

      - name: Format GitHub Response
        id: format-response
        run: |
          echo "=== GitHubå¿œç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ==="

          CATEGORY="${{ steps.categorize.outputs.category }}"
          PRIORITY="${{ steps.categorize.outputs.priority }}"
          ISSUE_AUTHOR="${{ steps.parse-issue.outputs.issue_author }}"

          # ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®çµµæ–‡å­—ã¨ã‚¿ã‚¤ãƒˆãƒ«
          case $CATEGORY in
            "bug")
              EMOJI="ğŸ›"
              TITLE="ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•åˆ†æ"
              ;;
            "feature")
              EMOJI="âœ¨"
              TITLE="æ©Ÿèƒ½è¦æœ›è‡ªå‹•åˆ†æ"
              ;;
            "question")
              EMOJI="â“"
              TITLE="è³ªå•è‡ªå‹•å¿œç­”"
              ;;
            "auth")
              EMOJI="ğŸ”"
              TITLE="èªè¨¼å•é¡Œè‡ªå‹•åˆ†æ"
              ;;
            "performance")
              EMOJI="âš¡"
              TITLE="ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œåˆ†æ"
              ;;
            *)
              EMOJI="ğŸ¤–"
              TITLE="è‡ªå‹•æŠ€è¡“ã‚µãƒãƒ¼ãƒˆ"
              ;;
          esac

          # å„ªå…ˆåº¦ãƒãƒƒã‚¸
          case $PRIORITY in
            "critical")
              PRIORITY_BADGE="ğŸ”´ ç·Šæ€¥"
              ;;
            "high")
              PRIORITY_BADGE="ğŸŸ  é«˜"
              ;;
            "medium")
              PRIORITY_BADGE="ğŸŸ¡ ä¸­"
              ;;
            "low")
              PRIORITY_BADGE="ğŸŸ¢ ä½"
              ;;
          esac

          # JSONå¿œç­”ã‚’èª­ã¿è¾¼ã¿
          ANALYSIS=$(python3 -c "import json; print(json.load(open('claude_response.json')).get('analysis', 'åˆ†ææƒ…å ±ãªã—'))" 2>/dev/null || echo "åˆ†æå–å¾—ã‚¨ãƒ©ãƒ¼")
          CATEGORY_INFO=$(python3 -c "import json; print(json.load(open('claude_response.json')).get('category_specific_info', ''))" 2>/dev/null || echo "")
          TECH_SOLUTION=$(python3 -c "import json; print(json.load(open('claude_response.json')).get('technical_solution', 'æŠ€è¡“çš„è§£æ±ºç­–ã‚’æ¤œè¨ä¸­'))" 2>/dev/null || echo "æŠ€è¡“çš„è§£æ±ºç­–ã‚’æ¤œè¨ä¸­")
          PREVENTION=$(python3 -c "import json; print(json.load(open('claude_response.json')).get('prevention', 'äºˆé˜²ç­–ã‚’æ¤œè¨ä¸­'))" 2>/dev/null || echo "äºˆé˜²ç­–ã‚’æ¤œè¨ä¸­")
          ESTIMATED_TIME=$(python3 -c "import json; print(json.load(open('claude_response.json')).get('estimated_time', 'æœªå®š'))" 2>/dev/null || echo "æœªå®š")
          DIFFICULTY=$(python3 -c "import json; print(json.load(open('claude_response.json')).get('difficulty', 'medium'))" 2>/dev/null || echo "medium")
          FOLLOW_UP=$(python3 -c "import json; print(json.load(open('claude_response.json')).get('follow_up', 'å¿…è¦ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã—ã¾ã™'))" 2>/dev/null || echo "å¿…è¦ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã—ã¾ã™")

          # å³åº§ã®è§£æ±ºæ‰‹é †ã‚’å–å¾—
          python3 << 'PYTHON_EOF' > immediate_steps.txt
          import json
          try:
              with open('claude_response.json') as f:
                  data = json.load(f)
              steps = data.get('immediate_steps', ['åˆæœŸå¯¾å¿œæ‰‹é †ã‚’æº–å‚™ä¸­'])
              for i, step in enumerate(steps, 1):
                  print(f"{i}. {step}")
          except:
              print("1. ãƒ–ãƒ©ã‚¦ã‚¶ã®å†èª­ã¿è¾¼ã¿ï¼ˆCtrl+F5ï¼‰ã‚’ãŠè©¦ã—ãã ã•ã„")
              print("2. é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„")
              print("3. åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚åŒæ§˜ã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã‹ã”ç¢ºèªãã ã•ã„")
          PYTHON_EOF

          # ãƒ†ã‚¹ãƒˆæ‰‹é †ã‚’å–å¾—
          python3 << 'PYTHON_EOF' > testing_steps.txt
          import json
          try:
              with open('claude_response.json') as f:
                  data = json.load(f)
              steps = data.get('testing_steps', ['ãƒ†ã‚¹ãƒˆæ‰‹é †ã‚’æº–å‚™ä¸­'])
              for i, step in enumerate(steps, 1):
                  print(f"{i}. {step}")
          except:
              print("1. å•é¡Œã®å†ç¾æ‰‹é †ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„")
              print("2. ä½¿ç”¨ç’°å¢ƒï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã€OSï¼‰ã‚’ãŠçŸ¥ã‚‰ã›ãã ã•ã„")
              print("3. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å…±æœ‰ã—ã¦ãã ã•ã„")
          PYTHON_EOF

          # ã‚³ãƒ¼ãƒ‰ææ¡ˆã‚’å–å¾—
          python3 << 'PYTHON_EOF' > code_suggestions.txt
          import json
          try:
              with open('claude_response.json') as f:
                  data = json.load(f)
              suggestions = data.get('code_suggestions', [])
              if suggestions:
                  for suggestion in suggestions:
                      print(f"### {suggestion.get('file', 'ãƒ•ã‚¡ã‚¤ãƒ«åä¸æ˜')}")
                      print(f"**å¤‰æ›´ç¨®åˆ¥**: {suggestion.get('change_type', 'ä¸æ˜')}")
                      print(f"**èª¬æ˜**: {suggestion.get('description', 'èª¬æ˜ãªã—')}")
                      if suggestion.get('code'):
                          print("```javascript")
                          print(suggestion['code'])
                          print("```")
                      print()
              else:
                  print("ã‚³ãƒ¼ãƒ‰ä¿®æ­£æ¡ˆã¯ç¾åœ¨æ¤œè¨ä¸­ã§ã™ã€‚")
          except Exception as e:
              print("ã‚³ãƒ¼ãƒ‰ææ¡ˆã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")
          PYTHON_EOF

          # GitHubå¿œç­”ã‚’ä½œæˆ
          cat > github_response.md << RESPONSE_EOF
          ## ${EMOJI} ${TITLE}

          @${ISSUE_AUTHOR} ã•ã‚“ã€ãŠå•ã„åˆã‚ã›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

          **å„ªå…ˆåº¦**: ${PRIORITY_BADGE} | **äºˆæƒ³è§£æ±ºæ™‚é–“**: ${ESTIMATED_TIME} | **é›£æ˜“åº¦**: ${DIFFICULTY}

          ---

          ### ğŸ” è‡ªå‹•åˆ†æçµæœ

          ${ANALYSIS}

          RESPONSE_EOF

          if [ -n "$CATEGORY_INFO" ]; then
            echo "" >> github_response.md
            echo "### ğŸ“‹ ã‚«ãƒ†ã‚´ãƒªåˆ¥æƒ…å ±" >> github_response.md
            echo "$CATEGORY_INFO" >> github_response.md
          fi

          cat >> github_response.md << RESPONSE_EOF

          ### ğŸš€ å³åº§ã®å¯¾å¿œæ‰‹é †

          RESPONSE_EOF
          cat immediate_steps.txt >> github_response.md

          cat >> github_response.md << RESPONSE_EOF

          ### ğŸ› ï¸ æŠ€è¡“çš„è§£æ±ºç­–

          ${TECH_SOLUTION}

          RESPONSE_EOF

          # ã‚³ãƒ¼ãƒ‰ææ¡ˆãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
          if [ -s code_suggestions.txt ] && ! grep -q "æ¤œè¨ä¸­" code_suggestions.txt; then
            echo "### ğŸ’» ã‚³ãƒ¼ãƒ‰ä¿®æ­£ææ¡ˆ" >> github_response.md
            echo "" >> github_response.md
            cat code_suggestions.txt >> github_response.md
          fi

          cat >> github_response.md << RESPONSE_EOF

          ### ğŸ§ª æ¤œè¨¼ãƒ»ãƒ†ã‚¹ãƒˆæ‰‹é †

          RESPONSE_EOF
          cat testing_steps.txt >> github_response.md

          cat >> github_response.md << RESPONSE_EOF

          ### ğŸ›¡ï¸ å†ç™ºé˜²æ­¢ç­–

          ${PREVENTION}

          ### ğŸ“ ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—

          ${FOLLOW_UP}

          ---

          ### ğŸ¤– è‡ªå‹•å¿œç­”ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±

          - **åˆ†æå®Ÿè¡Œæ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S JST')
          - **ã‚·ã‚¹ãƒ†ãƒ **: Claude Code + GitHub Actions
          - **å¿œç­”ãƒ¬ãƒ™ãƒ«**: é«˜åº¦æŠ€è¡“åˆ†æ
          - **Issueåˆ†é¡**: ${CATEGORY}

          ---

          ### ğŸ“š é–¢é€£ãƒªã‚½ãƒ¼ã‚¹

          - [ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦](https://github.com/${{ github.repository }}/blob/main/about.html)
          - [ã‚ˆãã‚ã‚‹è³ªå•](https://github.com/${{ github.repository }}/issues?q=label%3Aquestion)
          - [éå»ã®è§£æ±ºæ¸ˆã¿å•é¡Œ](https://github.com/${{ github.repository }}/issues?q=is%3Aissue+is%3Aclosed)

          ### âš¡ ç·Šæ€¥æ™‚ã®å¯¾å¿œ

          - ç·Šæ€¥æ€§ãŒé«˜ã„å ´åˆã¯ã€Issue ã‚¿ã‚¤ãƒˆãƒ«ã« \`[ç·Šæ€¥]\` ã‚’è¿½è¨˜ã—ã¦ãã ã•ã„
          - ãƒ‡ãƒ¼ã‚¿æå¤±ã®å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆã¯ã€å³åº§ã«ä½¿ç”¨ã‚’åœæ­¢ã—ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã”ç¢ºèªãã ã•ã„

          ---

          <sub>ã“ã®åˆ†æã¯ AI ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ä¿®æ­£æ¡ˆã¯å‚è€ƒã¨ã—ã¦æä¾›ã•ã‚Œã¦ãŠã‚Šã€å®Ÿè£…å‰ã«ååˆ†ãªæ¤œè¨¼ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚è¿½åŠ ã®ã‚µãƒãƒ¼ãƒˆãŒå¿…è¦ãªå ´åˆã¯ã€ãŠæ°—è»½ã«ã‚³ãƒ¡ãƒ³ãƒˆã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚</sub>
          RESPONSE_EOF

          echo "GitHubå¿œç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Œäº†"

      - name: Post Response to GitHub
        run: |
          echo "=== GitHubå¿œç­”æŠ•ç¨¿ ==="

          # GitHub APIã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ steps.parse-issue.outputs.issue_number }}/comments" \
            -d @- << CURL_EOF
          {
            "body": $(cat github_response.md | jq -Rs .)
          }
          CURL_EOF

          echo "GitHubå¿œç­”æŠ•ç¨¿å®Œäº†"

      - name: Update Issue Labels
        run: |
          echo "=== Issue ãƒ©ãƒ™ãƒ«æ›´æ–° ==="

          CATEGORY="${{ steps.categorize.outputs.category }}"
          PRIORITY="${{ steps.categorize.outputs.priority }}"

          # è‡ªå‹•åˆ†æãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          LABELS_TO_ADD="auto-analyzed"

          # ã‚«ãƒ†ã‚´ãƒªãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          case $CATEGORY in
            "bug")
              LABELS_TO_ADD="${LABELS_TO_ADD},auto-bug-analysis"
              ;;
            "feature")
              LABELS_TO_ADD="${LABELS_TO_ADD},auto-feature-analysis"
              ;;
            "question")
              LABELS_TO_ADD="${LABELS_TO_ADD},auto-question-answered"
              ;;
            "auth")
              LABELS_TO_ADD="${LABELS_TO_ADD},auto-auth-analysis"
              ;;
            "performance")
              LABELS_TO_ADD="${LABELS_TO_ADD},auto-performance-analysis"
              ;;
          esac

          # å„ªå…ˆåº¦ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          case $PRIORITY in
            "critical")
              LABELS_TO_ADD="${LABELS_TO_ADD},priority-critical"
              ;;
            "high")
              LABELS_TO_ADD="${LABELS_TO_ADD},priority-high"
              ;;
            "medium")
              LABELS_TO_ADD="${LABELS_TO_ADD},priority-medium"
              ;;
            "low")
              LABELS_TO_ADD="${LABELS_TO_ADD},priority-low"
              ;;
          esac

          # ãƒ©ãƒ™ãƒ«è¿½åŠ APIå‘¼ã³å‡ºã—
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ steps.parse-issue.outputs.issue_number }}/labels" \
            -d "{\"labels\": [$(echo $LABELS_TO_ADD | sed 's/,/","/g' | sed 's/^/"/' | sed 's/$/"/')]}}" \
            || echo "ãƒ©ãƒ™ãƒ«è¿½åŠ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™"

          echo "ãƒ©ãƒ™ãƒ«æ›´æ–°å®Œäº†"

      - name: Cleanup
        if: always()
        run: |
          echo "=== ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ==="
          rm -f issue_body.txt comment_body.txt claude_prompt.md claude_raw_output.txt
          rm -f claude_response.json immediate_steps.txt testing_steps.txt
          rm -f code_suggestions.txt github_response.md
          echo "ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤å®Œäº†"
