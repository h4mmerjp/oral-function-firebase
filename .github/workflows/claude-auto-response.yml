name: Claude Code Auto Response

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  claude-auto-response:
    runs-on: ubuntu-latest
    permissions:
      issues: write      # Issueã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¿…è¦
      contents: write    # ClaudeãŒã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦Pushã™ã‚‹å ´åˆã«å¿…è¦

    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ã®ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ãƒã‚§ãƒƒã‚¯
      - name: Check Event Trigger
        id: event-check
        run: |
          echo "=== ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ãƒã‚§ãƒƒã‚¯ ==="
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "should_process=true" >> $GITHUB_OUTPUT
            echo "ãƒˆãƒªã‚¬ãƒ¼: Issueä½œæˆã€‚å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™ã€‚"
            exit 0
          fi

          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_AUTHOR_TYPE="${{ github.event.comment.user.type }}"
            if [ "$COMMENT_AUTHOR_TYPE" = "Bot" ] || [ "$COMMENT_AUTHOR_TYPE" = "App" ]; then
              echo "should_process=false" >> $GITHUB_OUTPUT
              echo "ğŸš« ãƒœãƒƒãƒˆã¾ãŸã¯Appã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã®ãŸã‚ã€å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
              exit 0
            fi
            echo "should_process=true" >> $GITHUB_OUTPUT
            echo "âœ… äººé–“ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã€‚å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™ã€‚"
          fi

      # ã‚¹ãƒ†ãƒƒãƒ—2: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        if: steps.event-check.outputs.should_process == 'true'
        uses: actions/checkout@v4

      # ã‚¹ãƒ†ãƒƒãƒ—3: Claudeã«ã‚ˆã‚‹åˆ†æã¨å¿œç­”
      - name: Run Claude Analysis and Respond
        if: steps.event-check.outputs.should_process == 'true'
        uses: anthropics/claude-code-action@beta
        id: claude-analysis
        continue-on-error: true # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶šè¡Œ
        with:
          # èªè¨¼ã‚­ãƒ¼ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã‚’ä¿®æ­£
          claude_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã®æœ¬æ–‡å‚ç…§æ–¹æ³•ã‚’ä¿®æ­£
          direct_prompt: |
            ã‚ãªãŸã¯å£è…”æ©Ÿèƒ½ä½ä¸‹ç—‡è¨ºæ–­ãƒ»ç®¡ç†ã‚¢ãƒ—ãƒªã®ä¸Šç´šæŠ€è¡“ã‚µãƒãƒ¼ãƒˆAIã§ã™ã€‚
            ä»¥ä¸‹ã®å•ã„åˆã‚ã›ã«ã¤ã„ã¦ã€æŠ€è¡“çš„ãªè¦³ç‚¹ã‹ã‚‰åˆ†æã—ã€åŒ…æ‹¬çš„ãªã‚µãƒãƒ¼ãƒˆå¿œç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

            ## å•ã„åˆã‚ã›æƒ…å ±
            - **Issueç•ªå·**: #${{ github.event.issue.number }}
            - **å ±å‘Šè€…**: ${{ github.event.issue.user.login }}
            - **ã‚¿ã‚¤ãƒˆãƒ«**: ${{ github.event.issue.title }}

            ### è©³ç´°å†…å®¹
            ${{ github.event.issue.body }}

            ### è¿½åŠ ã‚³ãƒ¡ãƒ³ãƒˆ (è©²å½“ã™ã‚‹å ´åˆ)
            ${{ github.event_name == 'issue_comment' && github.event.comment.body || 'ãªã—' }}

            ## æŒ‡ç¤º
            ä»¥ä¸‹ã®å½¢å¼ã§å¿œç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            1. **å•é¡Œåˆ†æ**: æŠ€è¡“çš„ãªåŸå› ã¨å½±éŸ¿ç¯„å›²
            2. **å³åº§ã®å¯¾å¿œæ‰‹é †**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã§ãã‚‹ã“ã¨
            3. **æ’ä¹…çš„ãªè§£æ±ºç­–**: ã‚³ãƒ¼ãƒ‰ä¿®æ­£æ¡ˆã‚„ã‚·ã‚¹ãƒ†ãƒ å¤‰æ›´æ¡ˆ
            4. **ãƒ†ã‚¹ãƒˆæ‰‹é †**: è§£æ±ºã‚’ç¢ºèªã™ã‚‹æ–¹æ³•

            âš ï¸é‡è¦: å¿œç­”ã®æœ€å¾Œã«å¿…ãšã€Œã“ã®å¿œç­”ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã€ã¨ã„ã†ä¸€æ–‡ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
          trigger_phrase: ".*"
          mode: tag
          branch_prefix: claude/
          timeout_minutes: 10

      # ã‚¹ãƒ†ãƒƒãƒ—4: Claudeã®å®Ÿè¡Œçµæœã‚’ç¢ºèª
      - name: Check Claude Analysis Result
        if: steps.event-check.outputs.should_process == 'true'
        id: check-claude-result
        run: |
          if [ "${{ steps.claude-analysis.outcome }}" = "success" ]; then
            echo "claude_succeeded=true" >> $GITHUB_OUTPUT
            echo "âœ… Claudeã«ã‚ˆã‚‹åˆ†æãŒæˆåŠŸã—ã¾ã—ãŸã€‚"
          else
            echo "claude_succeeded=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Claudeã«ã‚ˆã‚‹åˆ†æãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã‚’æº–å‚™ã—ã¾ã™ã€‚"
          fi

      # ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã®æŠ•ç¨¿ (ClaudeãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ)
      - name: Post Fallback Response
        if: steps.check-claude-result.outputs.claude_succeeded == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fallbackBody = `
            ## âš ï¸ è‡ªå‹•åˆ†æã‚¨ãƒ©ãƒ¼
            @${{ github.event.issue.user.login }}ã•ã‚“ã€ãŠå•ã„åˆã‚ã›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
            ç¾åœ¨ã€AIã«ã‚ˆã‚‹è‡ªå‹•åˆ†æã‚·ã‚¹ãƒ†ãƒ ã§æŠ€è¡“çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ãŸãŸã‚ã€å¿œç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
            æ‹…å½“è€…ãŒå†…å®¹ã‚’ç¢ºèªã—ã€æ‰‹å‹•ã§å¯¾å¿œã„ãŸã—ã¾ã™ã®ã§ã€ä»Šã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚
            ã”ä¸ä¾¿ã‚’ãŠã‹ã‘ã—ã¦ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚
            ---
            <sub>âš ï¸ ã“ã®å¿œç­”ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚</sub>
            `;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: fallbackBody
            });
            console.log("ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã‚’Issueã«æŠ•ç¨¿ã—ã¾ã—ãŸã€‚");
