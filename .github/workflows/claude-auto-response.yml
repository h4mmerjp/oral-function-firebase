# .github/workflows/claude-auto-response.yml
name: Claude Code Auto Response

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  claude-auto-response:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Issue Information
        id: parse-issue
        run: |
          echo "=== Issueæƒ…å ±è§£æ ==="

          # Issueæƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
          if [ "${{ github.event_name }}" = "issues" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
            ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
            ISSUE_LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
            ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
            ISSUE_LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          fi

          # å‡ºåŠ›å¤‰æ•°ã«è¨­å®š
          echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
          echo "issue_title=${ISSUE_TITLE}" >> $GITHUB_OUTPUT
          echo "issue_author=${ISSUE_AUTHOR}" >> $GITHUB_OUTPUT
          echo "issue_labels=${ISSUE_LABELS}" >> $GITHUB_OUTPUT

          # Issueæœ¬æ–‡ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆç‰¹æ®Šæ–‡å­—å¯¾å¿œï¼‰
          echo "${ISSUE_BODY}" > issue_body.txt

          # ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯ä¿å­˜
          if [ -n "${COMMENT_BODY:-}" ]; then
            echo "${COMMENT_BODY}" > comment_body.txt
            echo "has_comment=true" >> $GITHUB_OUTPUT
            echo "comment_author=${COMMENT_AUTHOR}" >> $GITHUB_OUTPUT
          else
            echo "has_comment=false" >> $GITHUB_OUTPUT
          fi

          echo "Issue #${ISSUE_NUMBER} ã®æƒ…å ±ã‚’è§£æå®Œäº†"

      - name: Categorize Issue
        id: categorize
        run: |
          echo "=== Issueåˆ†é¡ ==="

          TITLE="${{ steps.parse-issue.outputs.issue_title }}"
          LABELS="${{ steps.parse-issue.outputs.issue_labels }}"
          BODY=$(cat issue_body.txt)

          # åˆ†é¡ãƒ­ã‚¸ãƒƒã‚¯
          CATEGORY="general"
          PRIORITY="medium"

          # ãƒ©ãƒ™ãƒ«ãƒ™ãƒ¼ã‚¹ã®åˆ†é¡
          if echo "${LABELS}" | grep -q "bug"; then
            CATEGORY="bug"
            PRIORITY="high"
          elif echo "${LABELS}" | grep -q "enhancement"; then
            CATEGORY="feature"
            PRIORITY="medium"
          elif echo "${LABELS}" | grep -q "question"; then
            CATEGORY="question"
            PRIORITY="low"
          elif echo "${LABELS}" | grep -q "authentication"; then
            CATEGORY="auth"
            PRIORITY="high"
          elif echo "${LABELS}" | grep -q "performance"; then
            CATEGORY="performance"
            PRIORITY="high"
          fi

          # ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ãƒ™ãƒ¼ã‚¹ã®åˆ†é¡ï¼ˆãƒ©ãƒ™ãƒ«ãŒãªã„å ´åˆï¼‰
          TEXT_ALL="${TITLE} ${BODY}"

          if echo "${TEXT_ALL}" | grep -qi "ãƒã‚°\|bug\|ã‚¨ãƒ©ãƒ¼\|error\|å‹•ã‹ãªã„\|å•é¡Œ\|ä¸å…·åˆ\|å¤±æ•—\|ã§ããªã„"; then
            if [ "$CATEGORY" = "general" ]; then
              CATEGORY="bug"
              PRIORITY="high"
            fi
          elif echo "${TEXT_ALL}" | grep -qi "æ©Ÿèƒ½\|feature\|è¿½åŠ \|æ”¹å–„\|enhancement\|è¦æœ›\|ã»ã—ã„\|ã§ãã‚‹ã‚ˆã†ã«"; then
            if [ "$CATEGORY" = "general" ]; then
              CATEGORY="feature"
              PRIORITY="medium"
            fi
          elif echo "${TEXT_ALL}" | grep -qi "è³ªå•\|question\|ä½¿ã„æ–¹\|how\|æ•™ãˆã¦\|help\|ã‚ã‹ã‚‰ãªã„\|æ–¹æ³•"; then
            if [ "$CATEGORY" = "general" ]; then
              CATEGORY="question"
              PRIORITY="low"
            fi
          elif echo "${TEXT_ALL}" | grep -qi "ãƒ­ã‚°ã‚¤ãƒ³\|login\|èªè¨¼\|auth\|google\|firebase\|ã‚µã‚¤ãƒ³ã‚¤ãƒ³"; then
            if [ "$CATEGORY" = "general" ]; then
              CATEGORY="auth"
              PRIORITY="high"
            fi
          elif echo "${TEXT_ALL}" | grep -qi "é…ã„\|é‡ã„\|performance\|ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹\|é€Ÿåº¦\|ãƒ¬ã‚¹ãƒãƒ³ã‚¹"; then
            if [ "$CATEGORY" = "general" ]; then
              CATEGORY="performance"
              PRIORITY="high"
            fi
          fi

          # ç·Šæ€¥åº¦åˆ¤å®š
          if echo "${TEXT_ALL}" | grep -qi "ç·Šæ€¥\|urgent\|emergency\|ãƒ‡ãƒ¼ã‚¿\|æ¶ˆãˆ\|å‰Šé™¤\|å£Šã‚Œ\|ä½¿ãˆãªã„"; then
            PRIORITY="critical"
          fi

          echo "category=${CATEGORY}" >> $GITHUB_OUTPUT
          echo "priority=${PRIORITY}" >> $GITHUB_OUTPUT

          echo "åˆ†é¡: ${CATEGORY}, å„ªå…ˆåº¦: ${PRIORITY}"

      - name: Create Claude Analysis Prompt
        id: create-prompt
        run: |
          echo "=== Claudeåˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ ==="

          CATEGORY="${{ steps.categorize.outputs.category }}"
          PRIORITY="${{ steps.categorize.outputs.priority }}"
          ISSUE_NUMBER="${{ steps.parse-issue.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.parse-issue.outputs.issue_title }}"
          ISSUE_AUTHOR="${{ steps.parse-issue.outputs.issue_author }}"

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®š
          CLAUDE_PROMPT="# å£è…”æ©Ÿèƒ½ä½ä¸‹ç—‡è¨ºæ–­ãƒ»ç®¡ç†ã‚¢ãƒ—ãƒª - æŠ€è¡“ã‚µãƒãƒ¼ãƒˆåˆ†æ

          ## æ‹…å½“AI
          ã‚ãªãŸã¯å£è…”æ©Ÿèƒ½ä½ä¸‹ç—‡è¨ºæ–­ãƒ»ç®¡ç†ã‚¢ãƒ—ãƒªã®ä¸Šç´šæŠ€è¡“ã‚µãƒãƒ¼ãƒˆAIã§ã™ã€‚

          ## å•ã„åˆã‚ã›æƒ…å ±
          - **Issueç•ªå·**: #${ISSUE_NUMBER}
          - **ã‚«ãƒ†ã‚´ãƒª**: ${CATEGORY}
          - **å„ªå…ˆåº¦**: ${PRIORITY}
          - **å ±å‘Šè€…**: ${ISSUE_AUTHOR}
          - **ã‚¿ã‚¤ãƒˆãƒ«**: ${ISSUE_TITLE}

          ### è©³ç´°å†…å®¹
          $(cat issue_body.txt)"

          if [ "${{ steps.parse-issue.outputs.has_comment }}" = "true" ]; then
            CLAUDE_PROMPT="${CLAUDE_PROMPT}

          ### è¿½åŠ ã‚³ãƒ¡ãƒ³ãƒˆ
          - **ã‚³ãƒ¡ãƒ³ãƒˆè€…**: ${{ steps.parse-issue.outputs.comment_author }}
          $(cat comment_body.txt)"
          fi

          CLAUDE_PROMPT="${CLAUDE_PROMPT}

          ## ã‚¢ãƒ—ãƒªæŠ€è¡“æƒ…å ±
          - **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: HTML5, CSS3, JavaScript (ES6+)
          - **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Firebase Firestore + ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
          - **èªè¨¼**: Google OAuth 2.0 (Firebase Authentication)
          - **UI**: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
          - **å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶**: Chrome, Firefox, Safari, Edge (æœ€æ–°ç‰ˆ)

          ## ä¸»è¦æ©Ÿèƒ½ã¨ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
          - **æ‚£è€…ç®¡ç†**: patients.js
          - **æ¤œæŸ»æ©Ÿèƒ½**: assessment.js
          - **ç®¡ç†è¨ˆç”»**: management.js
          - **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: database.js (Firebaseç‰ˆ)
          - **èªè¨¼**: firebase-config.js
          - **ãƒ¡ã‚¤ãƒ³**: app.js, index.html
          - **ã‚¹ã‚¿ã‚¤ãƒ«**: styles.css

          ## æŒ‡ç¤º
          ä»¥ä¸‹ã®å½¢å¼ã§åŒ…æ‹¬çš„ãªæŠ€è¡“ã‚µãƒãƒ¼ãƒˆå¿œç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

          1. **å•é¡Œåˆ†æ**: æŠ€è¡“çš„ãªåŸå› ã¨å½±éŸ¿ç¯„å›²
          2. **å³åº§ã®å¯¾å¿œæ‰‹é †**: 3ã¤ã®å…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—
          3. **æŠ€è¡“çš„è§£æ±ºç­–**: è©³ç´°ãªè§£æ±ºæ–¹æ³•
          4. **ãƒ†ã‚¹ãƒˆæ‰‹é †**: æ¤œè¨¼æ–¹æ³•
          5. **å†ç™ºé˜²æ­¢ç­–**: ä»Šå¾Œã®äºˆé˜²ç­–

          åŒ»ç™‚å¾“äº‹è€…å‘ã‘ã‚¢ãƒ—ãƒªã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨æ€§ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã‚’æœ€å„ªå…ˆã«è€ƒæ…®ã—ã¦ãã ã•ã„ã€‚"

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "${CLAUDE_PROMPT}" > claude_prompt.txt

          echo "Claudeåˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆå®Œäº†"

      - name: Run Claude Code Analysis
        uses: anthropics/claude-code-action@beta
        id: claude-analysis
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          direct_prompt: ${{ steps.create-prompt.outputs.claude_prompt }}
          trigger_phrase: "auto-analysis"
          custom_instructions: "Issue #${{ steps.parse-issue.outputs.issue_number }}ã®æŠ€è¡“ã‚µãƒãƒ¼ãƒˆåˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"

      - name: Create Fallback Response
        id: fallback-response
        if: failure() || steps.claude-analysis.outputs.response == ''
        run: |
          echo "=== ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ä½œæˆ ==="

          CATEGORY="${{ steps.categorize.outputs.category }}"
          PRIORITY="${{ steps.categorize.outputs.priority }}"
          ISSUE_AUTHOR="${{ steps.parse-issue.outputs.issue_author }}"

          # ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®çµµæ–‡å­—ã¨ã‚¿ã‚¤ãƒˆãƒ«
          case $CATEGORY in
            "bug")
              EMOJI="ğŸ›"
              TITLE="ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆå—ä»˜"
              ;;
            "feature")
              EMOJI="âœ¨"
              TITLE="æ©Ÿèƒ½è¦æœ›å—ä»˜"
              ;;
            "question")
              EMOJI="â“"
              TITLE="è³ªå•å—ä»˜"
              ;;
            "auth")
              EMOJI="ğŸ”"
              TITLE="èªè¨¼å•é¡Œå—ä»˜"
              ;;
            "performance")
              EMOJI="âš¡"
              TITLE="ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œå—ä»˜"
              ;;
            *)
              EMOJI="ğŸ¤–"
              TITLE="ãŠå•ã„åˆã‚ã›å—ä»˜"
              ;;
          esac

          # å„ªå…ˆåº¦ãƒãƒƒã‚¸
          case $PRIORITY in
            "critical")
              PRIORITY_BADGE="ğŸ”´ ç·Šæ€¥"
              ;;
            "high")
              PRIORITY_BADGE="ğŸŸ  é«˜"
              ;;
            "medium")
              PRIORITY_BADGE="ğŸŸ¡ ä¸­"
              ;;
            "low")
              PRIORITY_BADGE="ğŸŸ¢ ä½"
              ;;
          esac

          # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã‚’ä½œæˆ
          cat > fallback_response.md << 'EOF'
          ## ${EMOJI} ${TITLE}

          @${ISSUE_AUTHOR} ã•ã‚“ã€ãŠå•ã„åˆã‚ã›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

          **å„ªå…ˆåº¦**: ${PRIORITY_BADGE} | **äºˆæƒ³å¯¾å¿œæ™‚é–“**: 24æ™‚é–“ä»¥å†…

          ---

          ### ğŸ” è‡ªå‹•åˆ†æçµæœ

          ãŠå•ã„åˆã‚ã›å†…å®¹ã‚’ç¢ºèªã„ãŸã—ã¾ã—ãŸã€‚è©³ç´°ãªæŠ€è¡“åˆ†æã‚’é–‹å§‹ã—ã¦ãŠã‚Šã€24æ™‚é–“ä»¥å†…ã«å…·ä½“çš„ãªè§£æ±ºç­–ã‚’ãŠè¿”ã—ã„ãŸã—ã¾ã™ã€‚

          ### ğŸš€ å³åº§ã®å¯¾å¿œæ‰‹é †

          å•é¡Œã®è©³ç´°ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã‚’ãŠè©¦ã—ãã ã•ã„ï¼š

          1. **ãƒ–ãƒ©ã‚¦ã‚¶ã®å†èª­ã¿è¾¼ã¿**: Ctrl+F5ï¼ˆWindowsï¼‰ã¾ãŸã¯Cmd+Shift+Rï¼ˆMacï¼‰ã§å¼·åˆ¶æ›´æ–°
          2. **é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ç¢ºèª**: F12ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦Consoleã‚¿ãƒ–ã§ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
          3. **åˆ¥ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®æ¤œè¨¼**: Chromeã€Firefoxã€Safariãªã©åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§åŒæ§˜ã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã‹ç¢ºèª

          ### ğŸ› ï¸ æŠ€è¡“ã‚µãƒãƒ¼ãƒˆãƒãƒ¼ãƒ ã‹ã‚‰ã®å¯¾å¿œ

          - é–‹ç™ºãƒãƒ¼ãƒ ãŒæ‰‹å‹•ã§è©³ç´°åˆ†æã‚’å®Ÿæ–½ã—ã¾ã™
          - å¿…è¦ã«å¿œã˜ã¦è¿½åŠ æƒ…å ±ã‚’ãŠèãã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
          - è§£æ±ºç­–ãŒåˆ¤æ˜æ¬¡ç¬¬ã€ã‚³ãƒ¡ãƒ³ãƒˆã§å›ç­”ã„ãŸã—ã¾ã™

          ### ğŸ“ ç·Šæ€¥æ™‚ã®å¯¾å¿œ

          - ãƒ‡ãƒ¼ã‚¿æå¤±ã®å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆã¯ã€å³åº§ã«ä½¿ç”¨ã‚’åœæ­¢ã—ã¦ãã ã•ã„
          - ç·Šæ€¥æ€§ãŒé«˜ã„å ´åˆã¯ã€Issueã‚¿ã‚¤ãƒˆãƒ«ã« `[ç·Šæ€¥]` ã‚’è¿½è¨˜ã—ã¦ãã ã•ã„

          ---

          ### ğŸ“š é–¢é€£ãƒªã‚½ãƒ¼ã‚¹

          - [ã‚ˆãã‚ã‚‹è³ªå•](https://github.com/${{ github.repository }}/issues?q=label%3Aquestion)
          - [éå»ã®è§£æ±ºæ¸ˆã¿å•é¡Œ](https://github.com/${{ github.repository }}/issues?q=is%3Aissue+is%3Aclosed)

          ---

          <sub>ã“ã®å¿œç­”ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚æŠ€è¡“ã‚µãƒãƒ¼ãƒˆãƒãƒ¼ãƒ ãŒè©³ç´°åˆ†æã‚’è¡Œã„ã€24æ™‚é–“ä»¥å†…ã«è¿½åŠ å›ç­”ã„ãŸã—ã¾ã™ã€‚</sub>
          EOF

          # å¤‰æ•°ã‚’å±•é–‹
          sed -i "s/\${EMOJI}/$EMOJI/g" fallback_response.md
          sed -i "s/\${TITLE}/$TITLE/g" fallback_response.md
          sed -i "s/\${ISSUE_AUTHOR}/$ISSUE_AUTHOR/g" fallback_response.md
          sed -i "s/\${PRIORITY_BADGE}/$PRIORITY_BADGE/g" fallback_response.md

          echo "response_file=fallback_response.md" >> $GITHUB_OUTPUT
          echo "ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ä½œæˆå®Œäº†"

      - name: Format GitHub Response
        id: format-response
        run: |
          echo "=== GitHubå¿œç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ==="

          # Claude Codeã®å¿œç­”ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -n "${{ steps.claude-analysis.outputs.response }}" ]; then
            echo "Claude Codeå¿œç­”ã‚’ä½¿ç”¨"
            echo "${{ steps.claude-analysis.outputs.response }}" > final_response.md
            echo "response_file=final_response.md" >> $GITHUB_OUTPUT
          else
            echo "ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã‚’ä½¿ç”¨"
            cp fallback_response.md final_response.md
            echo "response_file=final_response.md" >> $GITHUB_OUTPUT
          fi

          echo "GitHubå¿œç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Œäº†"

      - name: Post Response to GitHub
        run: |
          echo "=== GitHubå¿œç­”æŠ•ç¨¿ ==="

          # å¿œç­”å†…å®¹ã‚’JSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦æŠ•ç¨¿
          RESPONSE_BODY=$(cat final_response.md | jq -Rs .)

          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ steps.parse-issue.outputs.issue_number }}/comments" \
            -d "{\"body\": $RESPONSE_BODY}"

          echo "GitHubå¿œç­”æŠ•ç¨¿å®Œäº†"

      - name: Update Issue Labels
        run: |
          echo "=== Issue ãƒ©ãƒ™ãƒ«æ›´æ–° ==="

          CATEGORY="${{ steps.categorize.outputs.category }}"
          PRIORITY="${{ steps.categorize.outputs.priority }}"

          # ãƒ©ãƒ™ãƒ«é…åˆ—ã‚’ä½œæˆ
          LABELS='["auto-analyzed"'

          # ã‚«ãƒ†ã‚´ãƒªãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          case $CATEGORY in
            "bug")
              LABELS="${LABELS},\"auto-bug-analysis\""
              ;;
            "feature")
              LABELS="${LABELS},\"auto-feature-analysis\""
              ;;
            "question")
              LABELS="${LABELS},\"auto-question-answered\""
              ;;
            "auth")
              LABELS="${LABELS},\"auto-auth-analysis\""
              ;;
            "performance")
              LABELS="${LABELS},\"auto-performance-analysis\""
              ;;
          esac

          # å„ªå…ˆåº¦ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          case $PRIORITY in
            "critical")
              LABELS="${LABELS},\"priority-critical\""
              ;;
            "high")
              LABELS="${LABELS},\"priority-high\""
              ;;
            "medium")
              LABELS="${LABELS},\"priority-medium\""
              ;;
            "low")
              LABELS="${LABELS},\"priority-low\""
              ;;
          esac

          LABELS="${LABELS}]"

          # ãƒ©ãƒ™ãƒ«è¿½åŠ APIå‘¼ã³å‡ºã—
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ steps.parse-issue.outputs.issue_number }}/labels" \
            -d "{\"labels\": $LABELS}" \
            || echo "ãƒ©ãƒ™ãƒ«è¿½åŠ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™"

          echo "ãƒ©ãƒ™ãƒ«æ›´æ–°å®Œäº†"

      - name: Cleanup
        if: always()
        run: |
          echo "=== ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ==="
          rm -f issue_body.txt comment_body.txt claude_prompt.txt
          rm -f fallback_response.md final_response.md
          echo "ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤å®Œäº†"
