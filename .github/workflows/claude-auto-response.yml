name: Claude Code Auto Response

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  claude-auto-response:
    runs-on: ubuntu-latest
    # å¿…è¦ãªæ¨©é™ã‚’æ˜ç¤ºçš„ã«è¨­å®šã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å‘ä¸Š
    permissions:
      issues: write
      contents: read # checkoutã«å¿…è¦

    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ã®è¦ï¼‰
      - name: Check Event Trigger
        id: event-check
        run: |
          echo "=== ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ãƒã‚§ãƒƒã‚¯ ==="
          # Issueä½œæˆã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã¯å¸¸ã«å‡¦ç†ã‚’ç¶šè¡Œ
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "should_process=true" >> $GITHUB_OUTPUT
            echo "ãƒˆãƒªã‚¬ãƒ¼: Issueä½œæˆã€‚å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™ã€‚"
            exit 0
          fi

          # ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã€ãƒœãƒƒãƒˆã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚’å³å¯†ã«ãƒã‚§ãƒƒã‚¯
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_AUTHOR_TYPE="${{ github.event.comment.user.type }}"
            COMMENT_AUTHOR_LOGIN="${{ github.event.comment.user.login }}"
            echo "ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆè€…: ${COMMENT_AUTHOR_LOGIN} (ã‚¿ã‚¤ãƒ—: ${COMMENT_AUTHOR_TYPE})"

            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—ãŒ 'Bot' ã¾ãŸã¯ 'App' ã®å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
            if [ "$COMMENT_AUTHOR_TYPE" = "Bot" ] || [ "$COMMENT_AUTHOR_TYPE" = "App" ]; then
              echo "should_process=false" >> $GITHUB_OUTPUT
              echo "ğŸš« ãƒœãƒƒãƒˆã¾ãŸã¯Appã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã®ãŸã‚ã€å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
              exit 0
            fi
            
            echo "should_process=true" >> $GITHUB_OUTPUT
            echo "âœ… äººé–“ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã€‚å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™ã€‚"
          fi

      # ã‚¹ãƒ†ãƒƒãƒ—2: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        if: steps.event-check.outputs.should_process == 'true'
        uses: actions/checkout@v4

      # ã‚¹ãƒ†ãƒƒãƒ—3: Issueæƒ…å ±ã®è§£æã¨ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
      - name: Parse Issue Information
        if: steps.event-check.outputs.should_process == 'true'
        id: parse-issue
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          echo "=== Issueæƒ…å ±è§£æ ==="
          if [ "${{ github.event_name }}" = "issues" ]; then
            EVENT_TYPE="issue_opened"
          else
            EVENT_TYPE="comment_created"
          fi
          
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
          echo "issue_author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
          echo "event_type=${EVENT_TYPE}" >> $GITHUB_OUTPUT

          # Issueæœ¬æ–‡ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆå®‰å…¨ãªæ–¹æ³•ï¼‰
          echo "$ISSUE_BODY" > issue_body.txt
          echo "Issueæœ¬æ–‡ã‚’ issue_body.txt ã«ä¿å­˜ã—ã¾ã—ãŸã€‚"

          # ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯ä¿å­˜
          if [ "$EVENT_TYPE" = "comment_created" ]; then
            echo "$COMMENT_BODY" > comment_body.txt
            echo "ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ comment_body.txt ã«ä¿å­˜ã—ã¾ã—ãŸã€‚"
            echo "has_comment=true" >> $GITHUB_OUTPUT
          else
            echo "has_comment=false" >> $GITHUB_OUTPUT
          fi

      # ã‚¹ãƒ†ãƒƒãƒ—4: Claudeã«ã‚ˆã‚‹åˆ†æã®å®Ÿè¡Œ
      - name: Run Claude Code Analysis
        if: steps.event-check.outputs.should_process == 'true'
        uses: anthropics/claude-code-action@beta
        id: claude-analysis
        with:
          claude_code_oauth_token: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: |
            ã‚ãªãŸã¯å£è…”æ©Ÿèƒ½ä½ä¸‹ç—‡è¨ºæ–­ãƒ»ç®¡ç†ã‚¢ãƒ—ãƒªã®ä¸Šç´šæŠ€è¡“ã‚µãƒãƒ¼ãƒˆAIã§ã™ã€‚
            ä»¥ä¸‹ã®å•ã„åˆã‚ã›ã«ã¤ã„ã¦ã€æŠ€è¡“çš„ãªè¦³ç‚¹ã‹ã‚‰åˆ†æã—ã€åŒ…æ‹¬çš„ãªã‚µãƒãƒ¼ãƒˆå¿œç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

            ## å•ã„åˆã‚ã›æƒ…å ±
            - **Issueç•ªå·**: #${{ steps.parse-issue.outputs.issue_number }}
            - **ã‚¤ãƒ™ãƒ³ãƒˆ**: ${{ steps.parse-issue.outputs.event_type }}
            - **å ±å‘Šè€…**: ${{ steps.parse-issue.outputs.issue_author }}
            - **ã‚¿ã‚¤ãƒˆãƒ«**: ${{ steps.parse-issue.outputs.issue_title }}

            ### è©³ç´°å†…å®¹
            ${{ env.ISSUE_BODY }}

            ### è¿½åŠ ã‚³ãƒ¡ãƒ³ãƒˆ (è©²å½“ã™ã‚‹å ´åˆ)
            ${{ env.COMMENT_BODY }}

            ## æŒ‡ç¤º
            ä»¥ä¸‹ã®å½¢å¼ã§å¿œç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            1. **å•é¡Œåˆ†æ**: æŠ€è¡“çš„ãªåŸå› ã¨å½±éŸ¿ç¯„å›²
            2. **å³åº§ã®å¯¾å¿œæ‰‹é †**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã§ãã‚‹ã“ã¨
            3. **æ’ä¹…çš„ãªè§£æ±ºç­–**: ã‚³ãƒ¼ãƒ‰ä¿®æ­£æ¡ˆã‚„ã‚·ã‚¹ãƒ†ãƒ å¤‰æ›´æ¡ˆ
            4. **ãƒ†ã‚¹ãƒˆæ‰‹é †**: è§£æ±ºã‚’ç¢ºèªã™ã‚‹æ–¹æ³•

            âš ï¸é‡è¦: å¿œç­”ã®æœ€å¾Œã«å¿…ãšã€Œã“ã®å¿œç­”ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã€ã¨ã„ã†ä¸€æ–‡ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
          trigger_phrase: ".*" # ã™ã¹ã¦ã®Issueã¨ã‚³ãƒ¡ãƒ³ãƒˆã«åå¿œ
          mode: tag
          branch_prefix: claude/
          timeout_minutes: 10
          use_sticky_comment: false

      # ã‚¹ãƒ†ãƒƒãƒ—5: Claudeã®å¿œç­”çµæœã‚’ãƒã‚§ãƒƒã‚¯
      - name: Check Claude Analysis Result
        if: steps.event-check.outputs.should_process == 'true'
        id: check-claude-result
        run: |
          echo "=== Claudeåˆ†æçµæœãƒã‚§ãƒƒã‚¯ ==="
          CLAUDE_OUTCOME="${{ steps.claude-analysis.outcome }}"
          CLAUDE_RESPONSE="${{ steps.claude-analysis.outputs.response }}"
          
          if [ "$CLAUDE_OUTCOME" = "success" ] && [ -n "$CLAUDE_RESPONSE" ] && [ "$CLAUDE_RESPONSE" != "null" ]; then
            echo "claude_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Claudeã«ã‚ˆã‚‹åˆ†æãŒæˆåŠŸã—ã€æœ‰åŠ¹ãªå¿œç­”ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚"
          else
            echo "claude_success=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Claudeã«ã‚ˆã‚‹åˆ†æãŒå¤±æ•—ã—ãŸã‹ã€å¿œç­”ãŒç©ºã§ã™ã€‚"
          fi

      # ã‚¹ãƒ†ãƒƒãƒ—6: å¿œç­”ã‚’Issueã«æŠ•ç¨¿
      - name: Post Response to Issue
        if: steps.event-check.outputs.should_process == 'true' && steps.check-claude-result.outputs.claude_success == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const response = `${{ steps.claude-analysis.outputs.response }}`;
            
            // è‡ªå‹•ç”Ÿæˆã®æ–‡è¨€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã€ãªã‘ã‚Œã°è¿½åŠ 
            let finalResponse = response;
            if (!response.includes("ã“ã®å¿œç­”ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚")) {
              finalResponse += "\n\n---\n<sub>âš ï¸ ã“ã®å¿œç­”ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚</sub>";
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: finalResponse
            });
            console.log("âœ… Claudeã®å¿œç­”ã‚’Issueã«æŠ•ç¨¿ã—ã¾ã—ãŸã€‚");

      # ã‚¹ãƒ†ãƒƒãƒ—7: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã®æŠ•ç¨¿ (ClaudeãŒå¤±æ•—ã—ãŸå ´åˆ)
      - name: Post Fallback Response
        if: steps.event-check.outputs.should_process == 'true' && steps.check-claude-result.outputs.claude_success == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fallbackBody = `
            ## âš ï¸ è‡ªå‹•åˆ†æã‚¨ãƒ©ãƒ¼

            ${{ steps.parse-issue.outputs.issue_author }}ã•ã‚“ã€ãŠå•ã„åˆã‚ã›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚

            ç¾åœ¨ã€AIã«ã‚ˆã‚‹è‡ªå‹•åˆ†æã‚·ã‚¹ãƒ†ãƒ ã§å•é¡ŒãŒç™ºç”Ÿã—ãŸãŸã‚ã€å¿œç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
            æ‹…å½“è€…ãŒå†…å®¹ã‚’ç¢ºèªã—ã€æ‰‹å‹•ã§å¯¾å¿œã„ãŸã—ã¾ã™ã®ã§ã€ä»Šã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚

            ã”ä¸ä¾¿ã‚’ãŠã‹ã‘ã—ã¦ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚

            ---
            <sub>âš ï¸ ã“ã®å¿œç­”ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚</sub>
            `;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: fallbackBody
            });
            console.log("âš ï¸ Claudeã®åˆ†æã«å¤±æ•—ã—ãŸãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸã€‚");

      # ã‚¹ãƒ†ãƒƒãƒ—8: ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      - name: Cleanup
        if: always() && steps.event-check.outputs.should_process == 'true'
        run: |
          echo "=== ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç† ==="
          rm -f issue_body.txt comment_body.txt
          echo "ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"

