name: Contact Form Handler

on:
  repository_dispatch:
    types: [contact-form-submission]

jobs:
  process-contact:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    outputs:
      issue-number: ${{ steps.create-issue.outputs.issue-number }}
      issue-url: ${{ steps.create-issue.outputs.issue-url }}

    steps:
      - name: Log Submission
        run: |
          echo "=== ãŠå•ã„åˆã‚ã›å‡¦ç†é–‹å§‹ ==="
          echo "æŠ•ç¨¿è€…: ${{ github.event.client_payload.name }}"
          echo "ã‚«ãƒ†ã‚´ãƒªãƒ¼: ${{ github.event.client_payload.category }}"
          echo "ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.client_payload.title }}"
          echo "æŠ•ç¨¿ID: ${{ github.event.client_payload.metadata.submissionId }}"
          echo "IP: ${{ github.event.client_payload.metadata.ip }}"
          echo "ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${{ github.event.client_payload.metadata.timestamp }}"

      - name: Validate Submission
        id: validate
        run: |
          # åŸºæœ¬çš„ãªæ¤œè¨¼
          NAME="${{ github.event.client_payload.name }}"
          CATEGORY="${{ github.event.client_payload.category }}"
          TITLE="${{ github.event.client_payload.title }}"
          MESSAGE="${{ github.event.client_payload.message }}"

          echo "=== ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ==="

          # å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
          if [ -z "$NAME" ] || [ -z "$CATEGORY" ] || [ -z "$TITLE" ] || [ -z "$MESSAGE" ]; then
            echo "error=å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™" >> $GITHUB_OUTPUT
            echo "validation_failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          # é•·ã•ãƒã‚§ãƒƒã‚¯
          if [ ${#TITLE} -gt 200 ]; then
            echo "error=ã‚¿ã‚¤ãƒˆãƒ«ãŒé•·ã™ãã¾ã™" >> $GITHUB_OUTPUT
            echo "validation_failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          # IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ï¼‰
          IP="${{ github.event.client_payload.metadata.ip }}"
          if [[ "$IP" =~ ^(127\.|10\.|172\.|192\.168\.) ]]; then
            echo "warning=ãƒ­ãƒ¼ã‚«ãƒ«IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: $IP"
          fi

          echo "validation_passed=true" >> $GITHUB_OUTPUT
          echo "=== ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº† ==="

      - name: Determine Issue Labels
        id: labels
        run: |
          CATEGORY="${{ github.event.client_payload.category }}"
          EMAIL="${{ github.event.client_payload.email }}"

          # ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ãƒ©ãƒ™ãƒ«
          case "$CATEGORY" in
            "bug")
              LABELS="private-submission,bug,needs-investigation"
              PRIORITY="high"
              ;;
            "feature")
              LABELS="private-submission,enhancement,user-request"
              PRIORITY="medium"
              ;;
            "question")
              LABELS="private-submission,question,documentation"
              PRIORITY="low"
              ;;
            "security")
              LABELS="private-submission,security,urgent"
              PRIORITY="critical"
              ;;
            *)
              LABELS="private-submission,general"
              PRIORITY="medium"
              ;;
          esac

          # é€£çµ¡å…ˆæœ‰ç„¡ã§ãƒ©ãƒ™ãƒ«è¿½åŠ 
          if [ -n "$EMAIL" ]; then
            LABELS="$LABELS,has-contact"
          else
            LABELS="$LABELS,no-contact"
          fi

          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT
          echo "=== ãƒ©ãƒ™ãƒ«æ±ºå®š: $LABELS ==="

      - name: Create Issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload.client_payload;
            const metadata = payload.metadata;

            // å®‰å…¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
            const sanitize = (text) => {
              if (!text) return 'ãªã—';
              return String(text).replace(/[<>&"']/g, (char) => {
                const entities = { '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#x27;' };
                return entities[char] || char;
              });
            };

            // Issueæœ¬æ–‡ã®æ§‹ç¯‰
            const issueBody = [
              '## ğŸ“ ãŠå•ã„åˆã‚ã›è©³ç´°',
              '',
              '### å ±å‘Šè€…æƒ…å ±',
              `- **åå‰**: ${sanitize(payload.name)}`,
              `- **é€£çµ¡å…ˆ**: ${sanitize(payload.email) || 'ãªã—'}`,
              `- **ã‚«ãƒ†ã‚´ãƒªãƒ¼**: ${sanitize(payload.category)}`,
              '',
              '### å†…å®¹',
              `**ä»¶å**: ${sanitize(payload.title)}`,
              '',
              '**è©³ç´°**:',
              sanitize(payload.message),
              '',
              '### ç’°å¢ƒæƒ…å ±',
              `- **ãƒ–ãƒ©ã‚¦ã‚¶**: ${sanitize(payload.browser) || 'ãªã—'}`,
              `- **User-Agent**: ${sanitize(metadata.userAgent) || 'ãªã—'}`,
              `- **Referer**: ${sanitize(metadata.referer) || 'ãªã—'}`,
              '',
              '### ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±',
              `- **æŠ•ç¨¿ID**: \`${sanitize(metadata.submissionId)}\``,
              `- **æŠ•ç¨¿æ—¥æ™‚**: ${sanitize(metadata.timestamp)}`,
              `- **é€ä¿¡å…ƒIP**: \`${sanitize(metadata.ip)}\``,
              `- **å‡¦ç†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: \`${context.workflow}\` (Run ID: ${context.runId})`,
              '',
              '---',
              '> ğŸ¤– ã“ã®Issueã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚',
              '> ',
              '> **å¯¾å¿œã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³**:',
              '> - å„ªå…ˆåº¦: **${{ steps.labels.outputs.priority }}**',
              '> - ç›®æ¨™å¿œç­”æ™‚é–“: 24æ™‚é–“ä»¥å†…',
              '> - è‡ªå‹•å¿œç­”ãŒæœ‰åŠ¹ã§ã™'
            ].join('\n');

            // Issueä½œæˆ
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[${payload.category.toUpperCase()}] ${payload.title}`,
              body: issueBody,
              labels: '${{ steps.labels.outputs.labels }}'.split(',').map(l => l.trim())
            });

            console.log(`âœ… Issue #${issue.data.number} ã‚’ä½œæˆã—ã¾ã—ãŸ`);
            console.log(`URL: ${issue.data.html_url}`);

            // å‡ºåŠ›è¨­å®š
            core.setOutput('issue-number', issue.data.number);
            core.setOutput('issue-url', issue.data.html_url);
            core.setOutput('issue-id', issue.data.id);

            return {
              issueNumber: issue.data.number,
              issueUrl: issue.data.html_url,
              issueId: issue.data.id
            };

      - name: Add Priority Label
        if: steps.labels.outputs.priority == 'critical'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-issue.outputs.issue-number }},
              labels: ['priority-critical', 'security']
            });

      - name: Set Issue Priority
        uses: actions/github-script@v7
        with:
          script: |
            const priority = '${{ steps.labels.outputs.priority }}';
            const issueNumber = ${{ steps.create-issue.outputs.issue-number }};

            // å„ªå…ˆåº¦ã«å¿œã˜ãŸãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
            if (priority === 'critical') {
              // é‡è¦åº¦ãŒé«˜ã„å ´åˆã¯ã‚¢ã‚µã‚¤ãƒ³ç­‰ã®å‡¦ç†ã‚’è¿½åŠ å¯èƒ½
              console.log(`ğŸš¨ Critical issue #${issueNumber} created`);
            }

      - name: Trigger Auto Response
        run: |
          echo "=== è‡ªå‹•å¿œç­”ãƒˆãƒªã‚¬ãƒ¼æº–å‚™ ==="
          echo "Issue #${{ steps.create-issue.outputs.issue-number }} ãŒä½œæˆã•ã‚Œã¾ã—ãŸ"
          echo "æ—¢å­˜ã®claude-auto-response.ymlãŒè‡ªå‹•çš„ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™"
          echo "å‡¦ç†å®Œäº†æ™‚åˆ»: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

      - name: Log Success
        run: |
          echo "=== å‡¦ç†å®Œäº†ã‚µãƒãƒªãƒ¼ ==="
          echo "âœ… æŠ•ç¨¿è€…: ${{ github.event.client_payload.name }}"
          echo "âœ… ã‚«ãƒ†ã‚´ãƒªãƒ¼: ${{ github.event.client_payload.category }}"
          echo "âœ… ä½œæˆã•ã‚ŒãŸIssue: #${{ steps.create-issue.outputs.issue-number }}"
          echo "âœ… ãƒ©ãƒ™ãƒ«: ${{ steps.labels.outputs.labels }}"
          echo "âœ… å„ªå…ˆåº¦: ${{ steps.labels.outputs.priority }}"
          echo "âœ… å‡¦ç†æ™‚é–“: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

  # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨ã‚¸ãƒ§ãƒ–
  handle-error:
    runs-on: ubuntu-latest
    if: failure()
    needs: process-contact
    steps:
      - name: Log Error
        run: |
          echo "âŒ ãŠå•ã„åˆã‚ã›å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          echo "æŠ•ç¨¿ID: ${{ github.event.client_payload.metadata.submissionId }}"
          echo "æŠ•ç¨¿è€…: ${{ github.event.client_payload.name }}"
          echo "ã‚¨ãƒ©ãƒ¼æ™‚åˆ»: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

      - name: Create Error Issue
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload.client_payload;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[ERROR] ãŠå•ã„åˆã‚ã›å‡¦ç†ã‚¨ãƒ©ãƒ¼ - ${payload.metadata.submissionId}`,
              body: [
                '## ğŸš¨ ãŠå•ã„åˆã‚ã›å‡¦ç†ã‚¨ãƒ©ãƒ¼',
                '',
                `**æŠ•ç¨¿ID**: \`${payload.metadata.submissionId}\``,
                `**æŠ•ç¨¿è€…**: ${payload.name}`,
                `**ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚åˆ»**: ${new Date().toISOString()}`,
                '',
                '**åŸå› **: ãŠå•ã„åˆã‚ã›ã®è‡ªå‹•å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚',
                '',
                '**å¯¾å¿œãŒå¿…è¦ãªé …ç›®**:',
                '- [ ] ã‚¨ãƒ©ãƒ¼åŸå› ã®èª¿æŸ»',
                `- [ ] æŠ•ç¨¿è€…ã¸ã®é€£çµ¡ï¼ˆé€£çµ¡å…ˆ: ${payload.email || 'ãªã—'}ï¼‰`,
                '- [ ] ã‚·ã‚¹ãƒ†ãƒ ã®ä¿®æ­£',
                '',
                'ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚æ‰‹å‹•ã§ã®å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚'
              ].join('\n'),
              labels: ['private-submission', 'error', 'manual-review', 'priority-high']
            });

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚¸ãƒ§ãƒ–
  security-audit:
    runs-on: ubuntu-latest
    if: github.event.client_payload.category == 'security'
    needs: process-contact
    steps:
      - name: Security Alert
        run: |
          echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ãŠå•ã„åˆã‚ã›ãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ"
          echo "Issue: #${{ needs.process-contact.outputs.issue-number }}"

      - name: Notify Security Team
        uses: actions/github-script@v7
        with:
          script: |
            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ ã¸ã®é€šçŸ¥
            const issueNumber = ${{ needs.process-contact.outputs.issue-number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                'ğŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ é€šçŸ¥**',
                '',
                'ã“ã®Issueã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ãŠå•ã„åˆã‚ã›ã¨ã—ã¦åˆ†é¡ã•ã‚Œã¾ã—ãŸã€‚',
                'å„ªå…ˆçš„ãªå¯¾å¿œãŒå¿…è¦ã§ã™ã€‚',
                '',
                '**å¯¾å¿œæ‰‹é †**:',
                '1. å†…å®¹ã®ç·Šæ€¥åº¦è©•ä¾¡',
                '2. å¿…è¦ã«å¿œã˜ã¦éå…¬é–‹ã§ã®å¯¾å¿œ',
                '3. ä¿®æ­£å¯¾å¿œã®å®Ÿæ–½',
                '4. æŠ•ç¨¿è€…ã¸ã®å ±å‘Š',
                '',
                '@maintainers ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ãŠå•ã„åˆã‚ã›ã§ã™ã€‚'
              ].join('\n')
            });
