<!-- contact.html - GitHub Issue連携版 -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>お問い合わせ - 口腔機能低下症診断・管理アプリ</title>
  <link rel="stylesheet" href="styles.css">
  <script src="security.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>お問い合わせ</h1>
      <p><a href="landing.html">← ログインページに戻る</a></p>
    </header>

    <div class="summary-card">
      <h2>お問い合わせ</h2>
      
      <p>口腔機能低下症診断・管理アプリに関するご質問・ご要望・不具合報告等がございましたら、以下のフォームからお気軽にお問い合わせください。</p>

      <div class="info-box" style="background: #e8f5e8; border: 1px solid #4caf50; padding: 15px; border-radius: 4px; margin: 20px 0;">
        <h4>🔒 プライベートサポート</h4>
        <p>お問い合わせは技術サポートチームが内部で管理し、プライバシーを保護します。</p>
        <p><strong>24時間以内に自動応答システムがお答えします。</strong></p>
      </div>

      <h3>📝 お問い合わせフォーム</h3>
      <div style="background: #f8f9fa; padding: 20px; border-radius: 4px; margin: 20px 0;">
        <form id="contact-form">
          <div class="form-group">
            <label for="contact-name">お名前（ニックネーム可） *</label>
            <input type="text" id="contact-name" required placeholder="例：田中先生、歯科医師A、など">
            <small style="color: #666;">※ 技術サポートチーム内でのみ使用されます。</small>
          </div>
          
          <div class="form-group">
            <label for="contact-email">メールアドレス（任意）</label>
            <input type="email" id="contact-email" placeholder="返信が必要な場合のみご入力ください">
            <small style="color: #666;">※ 追加情報が必要な場合の連絡先です。安全に保護されます。</small>
          </div>
          
          <div class="form-group">
            <label for="contact-category">お問い合わせ種別 *</label>
            <select id="contact-category" required>
              <option value="">選択してください</option>
              <option value="bug">不具合報告</option>
              <option value="feature">機能要望</option>
              <option value="question">使い方について</option>
              <option value="account">アカウント・ログイン</option>
              <option value="performance">パフォーマンス・速度</option>
              <option value="ui">UI・デザイン</option>
              <option value="compatibility">ブラウザ・デバイス対応</option>
              <option value="documentation">ドキュメント・ヘルプ</option>
              <option value="security">セキュリティ</option>
              <option value="other">その他</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="contact-title">タイトル *</label>
            <input type="text" id="contact-title" required placeholder="例：検査結果が保存されない、患者登録でエラーが発生する、など">
            <small style="color: #666;">※ 問題や要望を簡潔に表現してください。</small>
          </div>
          
          <div class="form-group">
            <label for="contact-message">詳細内容 *</label>
            <textarea id="contact-message" rows="8" required placeholder="具体的な状況や手順をご記入ください。

【推奨記載内容】
- 発生状況（いつ、どこで、何をした時に）
- 使用環境（ブラウザ、OS、デバイス）
- エラーメッセージ（あれば）
- 期待する動作"></textarea>
          </div>
          
          <div class="form-group">
            <label for="contact-browser">使用環境（任意）</label>
            <input type="text" id="contact-browser" placeholder="例：Chrome 120, Windows 11, iPhone Safari など">
          </div>

          <!-- プライバシー確認 -->
          <div class="form-group">
            <label class="checkbox-item">
              <input type="checkbox" id="privacy-agreement" required>
              <span>個人情報や患者情報を含まないことを確認しました</span>
            </label>
          </div>

          <div class="form-group">
            <label class="checkbox-item">
              <input type="checkbox" id="terms-agreement" required>
              <span>お問い合わせ内容の処理と技術サポートでの使用に同意します</span>
            </label>
          </div>
          
          <div class="form-group">
            <button type="button" onclick="submitContact()" class="btn-success">お問い合わせを送信</button>
            <button type="button" onclick="resetForm()" class="btn-secondary">リセット</button>
          </div>

          <!-- 送信状態表示 -->
          <div id="submission-status" style="display: none; margin-top: 15px;"></div>
        </form>
      </div>

      <h3>🔍 既存の問題・要望について</h3>
      <p>技術サポートチームが過去のお問い合わせを参照し、重複した問題の効率的な解決に努めています。</p>
      <div style="background: #f0f7ff; padding: 15px; border-radius: 4px; margin: 15px 0;">
        <p><strong>💡 お知らせ:</strong> よくあるご質問の充実と、24時間自動応答システムにより迅速な対応を実現しています。</p>
      </div>

      <h3>❓ よくあるご質問</h3>
      
      <details style="margin: 10px 0;">
        <summary style="cursor: pointer; font-weight: bold;">Q: ログインできません</summary>
        <p>A: Googleアカウントでのログインが必要です。ブラウザのCookieが有効になっていることを確認してください。ポップアップブロッカーの設定もご確認ください。</p>
      </details>
      
      <details style="margin: 10px 0;">
        <summary style="cursor: pointer; font-weight: bold;">Q: 患者データが消えました</summary>
        <p>A: ログインしていない状態ではデータが保存されません。必ずGoogleアカウントでログインしてご利用ください。オフライン時のデータは一時的なものです。</p>
      </details>
      
      <details style="margin: 10px 0;">
        <summary style="cursor: pointer; font-weight: bold;">Q: 5人以上の患者を登録したい</summary>
        <p>A: 無料プランは5人までの制限があります。プレミアムプランで無制限に登録できます（現在準備中）。</p>
      </details>
      
      <details style="margin: 10px 0;">
        <summary style="cursor: pointer; font-weight: bold;">Q: 診断結果の信頼性について</summary>
        <p>A: 本アプリは診断補助ツールです。最終的な診断や治療方針の決定は、必ず医療従事者の判断により行ってください。</p>
      </details>

      <details style="margin: 10px 0;">
        <summary style="cursor: pointer; font-weight: bold;">Q: スマートフォンで正常に動作しない</summary>
        <p>A: 最新のブラウザ（Chrome、Safari）をご利用ください。画面サイズの関係で、タブレット以上の画面サイズを推奨しています。</p>
      </details>

      <h3>🛡️ プライバシーについて</h3>
      <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin: 20px 0;">
        <p><strong>⚠️ 重要な注意事項</strong></p>
        <ul>
          <li>患者の個人情報（氏名、連絡先等）は絶対に入力しないでください</li>
          <li>医療情報や診断内容に関する具体的なデータは含めないでください</li>
          <li>緊急性の高い医療的な問題については、直接医療機関にご相談ください</li>
        </ul>
      </div>

  <script>
    // プライベートお問い合わせAPI呼び出し
    async function submitContact() {
      // バリデーション
      if (!validateForm()) return;
      
      // セキュリティバリデーション
      if (!validateSensitiveData()) return;

      const submitButton = document.querySelector('button[onclick="submitContact()"]');
      const statusDiv = document.getElementById('submission-status');
      
      // 送信状態表示
      submitButton.disabled = true;
      submitButton.textContent = '送信中...';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div style="color: #2196f3;">📤 お問い合わせを送信中...</div>';

      try {
        const formData = collectFormData();
        
        // 内部APIに送信（Vercel環境対応）
        const response = await fetch('/api/contact', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok) {
          // 成功メッセージ
          statusDiv.innerHTML = `
            <div style="color: #4caf50; background: #e8f5e8; padding: 15px; border-radius: 4px;">
              <h4>✅ 送信完了</h4>
              <p>${result.message}</p>
              <div style="margin: 10px 0; padding: 10px; background: #f0f7ff; border-radius: 4px;">
                <strong>📋 受付詳細:</strong><br>
                <small>
                  • 投稿ID: <code>${result.details.submissionId}</code><br>
                  • カテゴリー: ${result.details.category}<br>
                  • 予想応答時間: ${result.details.estimatedResponseTime}
                </small>
              </div>
              <p><strong>次のステップ:</strong></p>
              <ul style="margin: 5px 0; padding-left: 20px;">
                ${result.details.nextSteps.map(step => `<li>${step}</li>`).join('')}
              </ul>
            </div>
          `;
          
          // フォームをリセット
          setTimeout(() => {
            resetForm();
          }, 5000);

        } else {
          throw new Error(result.message || 'サーバーエラーが発生しました');
        }

      } catch (error) {
        console.error('送信エラー:', error);
        statusDiv.innerHTML = `
          <div style="color: #f44336; background: #ffebee; padding: 15px; border-radius: 4px;">
            <h4>❌ 送信に失敗しました</h4>
            <p>${error.message}</p>
            <p>お手数ですが、しばらく時間をおいてから再度お試しください。</p>
            <p>問題が続く場合は、ブラウザのコンソールログをご確認いただき、システム管理者にお知らせください。</p>
          </div>
        `;
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'お問い合わせを送信';
      }
    }

    function validateForm() {
      const name = document.getElementById('contact-name').value.trim();
      const category = document.getElementById('contact-category').value;
      const title = document.getElementById('contact-title').value.trim();
      const message = document.getElementById('contact-message').value.trim();
      const privacyAgreed = document.getElementById('privacy-agreement').checked;
      const termsAgreed = document.getElementById('terms-agreement').checked;

      if (!name || !category || !title || !message) {
        alert('必須項目をすべて入力してください。');
        return false;
      }

      if (!privacyAgreed || !termsAgreed) {
        alert('プライバシーと利用規約の確認事項にチェックを入れてください。');
        return false;
      }

      return true;
    }

    function collectFormData() {
      return {
        name: document.getElementById('contact-name').value.trim(),
        email: document.getElementById('contact-email').value.trim(),
        category: document.getElementById('contact-category').value,
        title: document.getElementById('contact-title').value.trim(),
        message: document.getElementById('contact-message').value.trim(),
        browser: document.getElementById('contact-browser').value.trim()
      };
    }

    function formatIssueBody(data) {
      let body = `## 報告者情報\n`;
      body += `**名前:** ${data.name}\n`;
      if (data.email) {
        body += `**連絡先:** ${data.email}\n`;
      }
      body += `**カテゴリー:** ${getCategoryText(data.category)}\n\n`;

      body += `## 詳細内容\n`;
      body += `${data.message}\n\n`;

      if (data.browser) {
        body += `## 使用環境\n`;
        body += `${data.browser}\n\n`;
      }

      body += `## 補足情報\n`;
      body += `- 報告日: ${new Date().toLocaleDateString('ja-JP')}\n`;
      body += `- 送信元: お問い合わせフォーム\n`;
      body += `- アプリバージョン: 2.0\n\n`;

      body += `---\n`;
      body += `このIssueは[お問い合わせフォーム](https://oral-function-firebase.vercel.app/contact.html)から自動生成されました。`;

      return body;
    }

    function getCategoryLabel(category) {
      const labels = {
        'bug': 'bug',
        'feature': 'enhancement',
        'question': 'question',
        'account': 'authentication',
        'performance': 'performance',
        'ui': 'ui/ux',
        'compatibility': 'compatibility',
        'documentation': 'documentation',
        'other': 'general'
      };
      return labels[category] || 'general';
    }

    function getCategoryText(category) {
      const texts = {
        'bug': '🐛 不具合報告',
        'feature': '✨ 機能要望',
        'question': '❓ 使い方について',
        'account': '🔐 アカウント・ログイン',
        'performance': '⚡ パフォーマンス・速度',
        'ui': '🎨 UI・デザイン',
        'compatibility': '📱 ブラウザ・デバイス対応',
        'documentation': '📚 ドキュメント・ヘルプ',
        'other': '🔧 その他'
      };
      return texts[category] || '🔧 その他';
    }

    function resetForm() {
      document.getElementById('contact-form').reset();
      document.getElementById('submission-status').style.display = 'none';
    }

    // セキュリティ機能用のスクリプト読み込み（存在チェック付き）
    function loadSecurityValidation() {
      if (typeof window.securityUtils === 'undefined') {
        // security.jsが読み込まれていない場合の基本バリデーション
        console.log('security.js not loaded, using basic validation');
        return {
          detectSensitiveData: function(content) {
            const basicPatterns = [
              /\d{3}-?\d{4}-?\d{4}/g, // 電話番号
              /[^\s]+@[^\s]+\.[^\s]+/g, // メールアドレス
              /(田中|佐藤|鈴木|高橋|山田|患者)/g // 基本的な個人情報キーワード
            ];
            
            let hasRisk = false;
            for (const pattern of basicPatterns) {
              if (pattern.test(content)) {
                hasRisk = true;
                break;
              }
            }
            
            return {
              hasSensitiveData: hasRisk,
              riskLevel: hasRisk ? 'medium' : 'safe',
              detectedItems: []
            };
          }
        };
      }
      return window.securityUtils;
    }

    // フォーム入力時のリアルタイムバリデーション（セキュリティ強化版）
    document.getElementById('contact-message').addEventListener('input', function() {
      const message = this.value;
      const warningDiv = document.getElementById('privacy-warning') || (() => {
        const div = document.createElement('div');
        div.id = 'privacy-warning';
        div.style.display = 'none';
        this.parentNode.appendChild(div);
        return div;
      })();

      // セキュリティユーティリティを使用して機密情報を検出
      const securityUtils = loadSecurityValidation();
      const sensitiveCheck = securityUtils.detectSensitiveData(message);

      if (sensitiveCheck.hasSensitiveData) {
        const riskColor = sensitiveCheck.riskLevel === 'high' ? '#d32f2f' : 
                         sensitiveCheck.riskLevel === 'medium' ? '#f57c00' : '#1976d2';
        
        let detailsHtml = '';
        if (sensitiveCheck.detectedItems && sensitiveCheck.detectedItems.length > 0) {
          detailsHtml = '<ul style="margin: 5px 0; padding-left: 20px;">';
          sensitiveCheck.detectedItems.forEach(item => {
            detailsHtml += `<li>${item.type}: ${item.count}件</li>`;
          });
          detailsHtml += '</ul>';
        }
        
        warningDiv.style.display = 'block';
        warningDiv.innerHTML = `
          <div style="color: ${riskColor}; background: ${riskColor}10; border: 1px solid ${riskColor}; padding: 10px; border-radius: 4px; margin-top: 10px;">
            ⚠️ <strong>個人情報や機密情報が検出されました</strong><br>
            リスクレベル: ${sensitiveCheck.riskLevel === 'high' ? '高' : sensitiveCheck.riskLevel === 'medium' ? '中' : '低'}
            ${detailsHtml}
            <small style="display: block; margin-top: 5px;">
              GitHub Issueは公開されます。個人を特定できる情報は削除してください。
            </small>
          </div>
        `;
      } else {
        warningDiv.style.display = 'none';
      }
    });

    // 送信前の最終バリデーション
    function validateSensitiveData() {
      const formData = collectFormData();
      const allContent = Object.values(formData).join(' ');
      
      const securityUtils = loadSecurityValidation();
      const sensitiveCheck = securityUtils.detectSensitiveData(allContent);
      
      if (sensitiveCheck.hasSensitiveData && sensitiveCheck.riskLevel === 'high') {
        const confirmMessage = `高リスクの個人情報が検出されました。\n\n本当に送信しますか？\n\n検出項目:\n${
          sensitiveCheck.detectedItems.map(item => `・${item.type}: ${item.count}件`).join('\n')
        }`;
        
        return confirm(confirmMessage);
      }
      
      return true;
    }
  </script>

  <style>
    .info-box {
      margin: 20px 0;
    }

    .info-box h4 {
      margin: 0 0 10px 0;
      color: #1976d2;
    }

    details {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
    }

    details summary {
      font-weight: bold;
      padding: 5px 0;
      outline: none;
    }

    details[open] summary {
      border-bottom: 1px solid #ddd;
      margin-bottom: 10px;
      padding-bottom: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: flex-start;
      margin: 10px 0;
    }

    .checkbox-item input[type="checkbox"] {
      margin-right: 10px;
      margin-top: 2px;
      width: auto;
    }

    .checkbox-item span {
      flex: 1;
    }

    small {
      display: block;
      margin-top: 5px;
      font-size: 12px;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</body>
</html>
