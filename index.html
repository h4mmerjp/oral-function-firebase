<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- セキュリティヘッダー -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; 
                script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://pagead2.googlesyndication.com; 
                style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
                font-src 'self' https://fonts.gstatic.com; 
                img-src 'self' data: https: blob:; 
                connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.firebaseapp.com wss://*.firebaseio.com; 
                frame-src 'self' https://accounts.google.com https://content.googleapis.com https://*.firebaseapp.com;"
    />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
    <meta
      http-equiv="Referrer-Policy"
      content="strict-origin-when-cross-origin"
    />

    <!-- AdSense審査用メタタグ -->
    <meta
      name="description"
      content="日本老年歯科医学会基準に基づく口腔機能低下症の診断・管理ツール。歯科医師・歯科衛生士向けの診断補助アプリケーション。"
    />
    <meta
      name="keywords"
      content="口腔機能,歯科,診断,管理,医療従事者,口腔機能低下症,日本老年歯科医学会"
    />
    <meta name="author" content="口腔機能低下症診断・管理アプリ" />

    <title>
      口腔機能低下症 診断・管理アプリ - 歯科医療従事者向け診断支援ツール
    </title>
    <link rel="stylesheet" href="styles.css" />

</head>
  <body>
    <div class="container">
      <header>
        <h1>口腔機能低下症 診断・管理アプリ</h1>
        <p>日本老年歯科医学会の基準に基づく診断・管理ツール</p>
        <div style="margin-top: 10px">
          <button onclick="exportDatabaseCSV()" class="btn-secondary no-print">
            CSVエクスポート
          </button>
          <button onclick="window.print()" class="btn-secondary no-print">
            印刷
          </button>
        </div>
      </header>

      <div class="tabs no-print">
        <div class="tab active" onclick="openTab('patient-list')">患者一覧</div>
        <div class="tab" onclick="openTab('patient-info')">患者情報</div>
        <div class="tab" onclick="openTab('assessment')">口腔機能精密検査</div>
        <div class="tab" onclick="openTab('diagnosis')">診断結果</div>
        <div class="tab" onclick="openTab('management-plan')">管理計画書</div>
        <div class="tab" onclick="openTab('progress-record')">
          管理指導記録簿
        </div>
        <div class="tab" onclick="openTab('patient-history')">履歴・統計</div>
        <div class="tab" onclick="openTab('information')">参考情報</div>
        <div class="tab" onclick="openTab('contact')">お問い合わせ</div>
      </div>

      <!-- Patient List Tab -->
      <div id="patient-list" class="tab-content active">
        <h2>患者一覧</h2>

        <div class="search-container">
          <input
            type="text"
            id="search-patients"
            placeholder="患者名、患者IDで検索..."
            onkeyup="searchPatients()"
          />
          <select id="filter-status" onchange="filterPatients()">
            <option value="">すべて表示</option>
            <option value="diagnosed">口腔機能低下症</option>
            <option value="normal">正常</option>
            <option value="pending">未診断</option>
          </select>
          <button onclick="showAddPatientModal()" class="btn-success">
            新規患者登録
          </button>
        </div>

        <div id="patients-grid" class="grid-container">
          <div class="no-patients">
            <p>登録された患者がありません。</p>
            <button onclick="showAddPatientModal()" class="btn-success">
              最初の患者を登録
            </button>
          </div>
        </div>
      </div>

      <!-- Patient Information Tab -->
      <div id="patient-info" class="tab-content">
        <h2>患者基本情報</h2>
        <div id="patient-info-content">
          <p>患者一覧から患者を選択するか、新規登録を行ってください。</p>
        </div>
      </div>

      <!-- Assessment Tab -->
      <div id="assessment" class="tab-content">
        <h2>口腔機能精密検査</h2>
        <div id="assessment-content">
          <p>患者を選択してから検査を開始してください。</p>
        </div>
      </div>

      <!-- Diagnosis Tab -->
      <div id="diagnosis" class="tab-content">
        <h2>診断結果</h2>
        <div id="diagnosis-content">
          <p>検査完了後に診断結果が表示されます。</p>
        </div>
      </div>

      <!-- Management Plan Tab -->
      <div id="management-plan" class="tab-content">
        <h2>管理計画書</h2>
        <div id="management-plan-content">
          <p>診断完了後に管理計画書が作成できます。</p>
        </div>
      </div>

      <!-- Progress Record Tab -->
      <div id="progress-record" class="tab-content">
        <h2>管理指導記録簿</h2>
        <div id="progress-record-content">
          <p>患者を選択して管理指導記録を入力してください。</p>
        </div>
      </div>

      <!-- Patient History Tab -->
      <div id="patient-history" class="tab-content">
        <h2>履歴・統計</h2>
        <div id="patient-history-content">
          <p>患者を選択して履歴を確認してください。</p>
        </div>
      </div>

      <!-- Information Tab -->
      <div id="information" class="tab-content">
        <h2>口腔機能低下症に関する参考情報</h2>

        <div class="summary-card">
          <h3>口腔機能低下症とは</h3>
          <p>
            口腔機能低下症は、加齢だけでなく，疾患や障害など様々な要因によって，口腔の機能が複合的に低下している疾患です。放置しておくと咀嚼障害，摂食嚥下障害など口腔の機能障害を引き起こし，また，低栄養やフレイル、サルコペニアを進展させるなど全身の健康を損なう可能性があります。
          </p>
          <p>
            口腔機能低下症の7つの下位症状（口腔衛生状態不良，口腔乾燥，咬合力低下，舌口唇運動機能低下，低舌圧，咀嚼機能低下，嚥下機能低下）のうち，3項目以上該当する場合に口腔機能低下症と診断されます。
          </p>
        </div>

        <div class="summary-card">
          <h3>口腔機能低下症とオーラルフレイル</h3>
          <p>
            オーラルフレイルは、わずかなむせや食べこぼし、滑舌の低下といった口腔機能が低下した状態を示すものであり、国民の啓発に用いる用語（キャッチフレーズ）です。
          </p>
          <p>
            一方、口腔機能低下症は、検査結果に基づく疾患名です。従って、オーラルフレイルと口腔機能低下症はオーバーラップされる部分が多く、区別されるものではありません。
          </p>
        </div>

        <div class="summary-card">
          <h3>口腔機能低下症の管理</h3>
          <p>
            口腔機能低下症の管理は，口腔機能のさらなる悪化を予防し，口腔機能を維持，回復することを目的とします。
          </p>
          <h4>各症状の管理方法例</h4>
          <table>
            <thead>
              <tr>
                <th>症状・状態</th>
                <th>管理方法の例</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>口腔衛生状態不良</td>
                <td>
                  歯科医師・歯科衛生士による口腔衛生管理、患者や家族等による口腔ケアの指導
                </td>
              </tr>
              <tr>
                <td>口腔乾燥</td>
                <td>
                  水分管理・水分補給の指導、唾液腺マッサージの指導・健口体操、口腔保湿剤の指導
                </td>
              </tr>
              <tr>
                <td>口唇・舌の機能低下</td>
                <td>
                  「パ」「タ」「カ」の繰り返し発音訓練の指導、口唇・舌の自動運動の指導
                </td>
              </tr>
              <tr>
                <td>咬合力・咀嚼機能の低下</td>
                <td>咬合支持の確立，義歯の製作・調整、咀嚼指導、食事指導</td>
              </tr>
              <tr>
                <td>嚥下機能の低下</td>
                <td>嚥下体操の指導、開口訓練、嚥下の間接訓練・直接訓練</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="summary-card">
           <h3>参考資料・リンク</h3>
        <ul>
          <li><a href="https://www.jads.jp/assets/pdf/basic/r06/document-240329.pdf" target="_blank" rel="noopener noreferrer">日本歯科医学会：口腔機能低下症に関する基本的な考え方</a></li>
          <li><a href="https://www.gerodontology.jp/" target="_blank" rel="noopener noreferrer">日本老年歯科医学会：公式ホームページ</a></li>
        </ul>
        </div>
      </div>

      <!-- Contact Tab -->
      <div id="contact" class="tab-content">
        <h2>お問い合わせ</h2>
        
        <div id="auth-required-message" class="summary-card" style="background: #fff3cd; border: 1px solid #ffeaa7; display: none;">
          <h3>🔐 ログインが必要です</h3>
          <p>お問い合わせフォームをご利用いただくには、Googleアカウントでのログインが必要です。</p>
          <p>ログイン後、メールアドレスが自動的に入力され、より安全にお問い合わせいただけます。</p>
          <div style="text-align: center; margin-top: 15px;">
            <button onclick="firebaseManager.signInWithGoogle()" class="btn-success">Googleでログイン</button>
          </div>
        </div>

        <div id="contact-form-container" style="display: none;">
          <div class="summary-card">
            <p>口腔機能低下症診断・管理アプリに関するご質問・ご要望・不具合報告等がございましたら、以下のフォームからお気軽にお問い合わせください。</p>

            <div class="info-box" style="background: #e8f5e8; border: 1px solid #4caf50; padding: 15px; border-radius: 4px; margin: 20px 0;">
              <h4>🔒 認証済みサポート</h4>
              <p>ログイン認証により、より安全で迅速なサポートを提供いたします。</p>
              <p><strong>24時間以内に自動応答システムがお答えします。</strong></p>
            </div>

            <form id="authenticated-contact-form">
              <div class="form-group">
                <label for="auth-contact-name">お名前 *</label>
                <input type="text" id="auth-contact-name" required readonly style="background: #f8f9fa;">
                <small style="color: #666;">※ ログインアカウント情報から自動入力</small>
              </div>
              
              <div class="form-group">
                <label for="auth-contact-email">メールアドレス *</label>
                <input type="email" id="auth-contact-email" required readonly style="background: #f8f9fa;">
                <small style="color: #666;">※ ログインアカウントのメールアドレス（編集不可）</small>
              </div>
              
              <div class="form-group">
                <label for="auth-contact-category">お問い合わせ種別 *</label>
                <select id="auth-contact-category" required>
                  <option value="">選択してください</option>
                  <option value="bug">不具合報告</option>
                  <option value="feature">機能要望</option>
                  <option value="question">使い方について</option>
                  <option value="account">アカウント・ログイン</option>
                  <option value="performance">パフォーマンス・速度</option>
                  <option value="ui">UI・デザイン</option>
                  <option value="compatibility">ブラウザ・デバイス対応</option>
                  <option value="documentation">ドキュメント・ヘルプ</option>
                  <option value="security">セキュリティ</option>
                  <option value="other">その他</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="auth-contact-title">タイトル *</label>
                <input type="text" id="auth-contact-title" required placeholder="例：検査結果が保存されない、患者登録でエラーが発生する、など">
              </div>
              
              <div class="form-group">
                <label for="auth-contact-message">詳細内容 *</label>
                <textarea id="auth-contact-message" rows="8" required placeholder="具体的な状況や手順をご記入ください。

【推奨記載内容】
- 発生状況（いつ、どこで、何をした時に）
- 使用環境（ブラウザ、OS、デバイス）
- エラーメッセージ（あれば）
- 期待する動作"></textarea>
              </div>
              
              <div class="form-group">
                <label for="auth-contact-browser">使用環境（任意）</label>
                <input type="text" id="auth-contact-browser" placeholder="例：Chrome 120, Windows 11, iPhone Safari など">
              </div>

              <div class="form-group">
                <label class="checkbox-item">
                  <input type="checkbox" id="auth-privacy-agreement" required>
                  <span>個人情報や患者情報を含まないことを確認しました</span>
                </label>
              </div>

              <div class="form-group">
                <label class="checkbox-item">
                  <input type="checkbox" id="auth-terms-agreement" required>
                  <span>お問い合わせ内容の処理と技術サポートでの使用に同意します</span>
                </label>
              </div>
              
              <div class="form-group">
                <button type="button" onclick="submitAuthenticatedContact()" class="btn-success">お問い合わせを送信</button>
                <button type="button" onclick="resetAuthContactForm()" class="btn-secondary">リセット</button>
              </div>

              <div id="auth-submission-status" style="display: none; margin-top: 15px;"></div>
            </form>
          </div>

          <div class="summary-card">
            <h3>❓ よくあるご質問</h3>
            <p>よくあるご質問は、<a href="faq.html" target="_blank">専用ページ</a>でログインなしでもご覧いただけます。</p>
            <div style="text-align: center; margin: 15px 0;">
              <button onclick="window.open('faq.html', '_blank')" class="btn-secondary">よくある質問を見る</button>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Release Notes Section -->
    <footer class="app-footer no-print">
      <div
        style="
          text-align: center;
          padding: 20px;
          border-top: 1px solid #eee;
          margin-top: 30px;
        "
      >
        <!-- 必須リンク -->
        <div style="margin-bottom: 15px">
          <a href="about.html" style="margin: 0 10px">アプリについて</a>
          <a href="privacy-policy.html" style="margin: 0 10px"
            >プライバシーポリシー</a
          >
          <a href="terms-of-service.html" style="margin: 0 10px">利用規約</a>
          <a href="contact.html" style="margin: 0 10px">お問い合わせ</a>
        </div>

        <!-- リリースノートボタン -->
        <button
          onclick="showReleaseNotes()"
          class="btn-secondary"
          style="margin: 5px"
        >
          📋 更新情報・リリースノート
        </button>

        <!-- コピーライトとアプリ説明 -->
        <p style="font-size: 12px; color: #666; margin: 10px 0">
          口腔機能低下症診断・管理アプリ | 日本老年歯科医学会基準準拠
        </p>

        <p style="font-size: 11px; color: #999; margin: 5px 0">
          ※
          本アプリは診断補助ツールです。最終的な診断は医療従事者が行ってください。
        </p>

      </div>
    </footer>

    <!-- Release Notes Modal -->
    <div id="releaseNotesModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeReleaseNotesModal()">&times;</span>
        <h2>📋 更新情報・リリースノート</h2>
        <div id="release-notes-content">
          <div style="text-align: center; padding: 20px">
            <p>更新情報を読み込み中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Patient Modal -->
    <div id="addPatientModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeAddPatientModal()">&times;</span>
        <h2 id="modal-title">新規患者登録</h2>
        <form id="patient-form">
          <input type="hidden" id="edit-patient-id" />

          <div class="grid-container">
            <div class="form-group">
              <label for="modal-patient-name">患者氏名 *</label>
              <input type="text" id="modal-patient-name" required />
            </div>
            <div class="form-group">
              <label for="modal-patient-id">患者ID *</label>
              <input type="text" id="modal-patient-id" required />
            </div>
            <div class="form-group">
              <label for="modal-patient-kana">フリガナ</label>
              <input type="text" id="modal-patient-kana" />
            </div>
            <div class="form-group">
              <label for="modal-birthdate">生年月日</label>
              <input type="date" id="modal-birthdate" />
            </div>
            <div class="form-group">
              <label for="modal-gender">性別</label>
              <select id="modal-gender">
                <option value="">選択してください</option>
                <option value="male">男性</option>
                <option value="female">女性</option>
              </select>
            </div>
            <div class="form-group">
              <label for="modal-phone">電話番号</label>
              <input type="tel" id="modal-phone" />
            </div>
          </div>

          <div class="form-group">
            <label for="modal-address">住所</label>
            <textarea id="modal-address" rows="3"></textarea>
          </div>

          <div style="text-align: right; margin-top: 20px">
            <button
              type="button"
              onclick="closeAddPatientModal()"
              class="btn-secondary"
            >
              キャンセル
            </button>
            <button type="submit" class="btn-success">保存</button>
          </div>
        </form>
      </div>
    </div>

    <!-- File input for import -->

    <!-- Firebase SDKをCDNから読み込み（v8 compat版を使用） -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- スクリプト読み込み順序を最適化 -->
    <script>
      // 初期化状況を監視するためのフラグ
      window.appInitStatus = {
        database: false,
        patients: false,
        assessment: false,
        management: false,
        firebase: false,
        security: false,
        app: false,
      };

      // 初期化完了を監視する関数
      function checkInitialization() {
        const allInitialized = Object.values(window.appInitStatus).every(
          (status) => status
        );
        if (allInitialized) {
          console.log("すべてのモジュールが初期化完了しました");
          console.log("初期化状況:", window.appInitStatus);
        } else {
          console.log("初期化待機中:", window.appInitStatus);
        }
      }
    </script>

    <!-- Firebase設定を最初に読み込み -->
    <script src="firebase-config.js"></script>
    <script>
      if (typeof firebaseManager !== "undefined") {
        window.appInitStatus.firebase = true;
        console.log("firebase-config.js 読み込み完了");

        // Firebase初期化を非同期で実行
        firebaseManager.initialize().then((success) => {
          if (success) {
            console.log("Firebase 初期化成功");
          } else {
            console.log("Firebase 初期化失敗 - ローカルモードで続行");
          }
        });
      }
    </script>

    <script src="database.js"></script>
    <script>
      if (typeof db !== "undefined") {
        window.appInitStatus.database = true;
        console.log("database.js 読み込み完了");
      }
    </script>

    <script src="patients.js"></script>
    <script>
      if (typeof patientManager !== "undefined") {
        window.appInitStatus.patients = true;
        console.log("patients.js 読み込み完了");
      }
    </script>

    <script src="assessment.js"></script>
    <script>
      if (typeof assessmentManager !== "undefined") {
        window.appInitStatus.assessment = true;
        console.log("assessment.js 読み込み完了");
      }
    </script>

    <script src="management.js"></script>
    <script>
      if (typeof managementManager !== "undefined") {
        window.appInitStatus.management = true;
        console.log("management.js 読み込み完了");
      }
    </script>

    <script src="security.js"></script>
    <script>
      if (typeof securityUtils !== "undefined") {
        window.appInitStatus.security = true;
        console.log("security.js 読み込み完了");
      }
    </script>

    <script src="app.js"></script>

    <script>
      if (typeof app !== "undefined" || typeof OralHealthApp !== "undefined") {
        window.appInitStatus.app = true;
        console.log("app.js 読み込み完了");
      }

      // 最終的な初期化状況を確認
      setTimeout(checkInitialization, 1000);

      // Contact form authentication check
      function checkContactAuthentication() {
        const user = firebaseManager.getCurrentUser();
        const authMessage = document.getElementById('auth-required-message');
        const formContainer = document.getElementById('contact-form-container');
        
        if (user) {
          // User is authenticated
          authMessage.style.display = 'none';
          formContainer.style.display = 'block';
          
          // Auto-populate user information
          document.getElementById('auth-contact-name').value = user.displayName || user.email.split('@')[0];
          document.getElementById('auth-contact-email').value = user.email;
        } else {
          // User is not authenticated
          authMessage.style.display = 'block';
          formContainer.style.display = 'none';
        }
      }

      // Handle authenticated contact form submission
      async function submitAuthenticatedContact() {
        if (!validateAuthContactForm()) return;
        
        const submitButton = document.querySelector('button[onclick="submitAuthenticatedContact()"]');
        const statusDiv = document.getElementById('auth-submission-status');
        
        submitButton.disabled = true;
        submitButton.textContent = '送信中...';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<div style="color: #2196f3;">📤 お問い合わせを送信中...</div>';

        try {
          const formData = collectAuthContactFormData();
          
          const response = await fetch('/api/contact', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
          });

          const result = await response.json();

          if (response.ok) {
            statusDiv.innerHTML = `
              <div style="color: #4caf50; background: #e8f5e8; padding: 15px; border-radius: 4px;">
                <h4>✅ 送信完了</h4>
                <p>${result.message}</p>
                <div style="margin: 10px 0; padding: 10px; background: #f0f7ff; border-radius: 4px;">
                  <strong>📋 受付詳細:</strong><br>
                  <small>
                    • 投稿ID: <code>${result.details.submissionId}</code><br>
                    • カテゴリー: ${result.details.category}<br>
                    • 予想応答時間: ${result.details.estimatedResponseTime}
                  </small>
                </div>
                <p><strong>次のステップ:</strong></p>
                <ul style="margin: 5px 0; padding-left: 20px;">
                  ${result.details.nextSteps.map(step => `<li>${step}</li>`).join('')}
                </ul>
              </div>
            `;
            
            setTimeout(() => {
              resetAuthContactForm();
            }, 5000);

          } else {
            throw new Error(result.message || 'サーバーエラーが発生しました');
          }

        } catch (error) {
          console.error('送信エラー:', error);
          statusDiv.innerHTML = `
            <div style="color: #f44336; background: #ffebee; padding: 15px; border-radius: 4px;">
              <h4>❌ 送信に失敗しました</h4>
              <p>${error.message}</p>
              <p>お手数ですが、しばらく時間をおいてから再度お試しください。</p>
            </div>
          `;
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = 'お問い合わせを送信';
        }
      }

      // Validate authenticated contact form
      function validateAuthContactForm() {
        const category = document.getElementById('auth-contact-category').value;
        const title = document.getElementById('auth-contact-title').value.trim();
        const message = document.getElementById('auth-contact-message').value.trim();
        const privacyAgreed = document.getElementById('auth-privacy-agreement').checked;
        const termsAgreed = document.getElementById('auth-terms-agreement').checked;

        if (!category || !title || !message) {
          alert('必須項目をすべて入力してください。');
          return false;
        }

        if (!privacyAgreed || !termsAgreed) {
          alert('プライバシーと利用規約の確認事項にチェックを入れてください。');
          return false;
        }

        return true;
      }

      // Collect authenticated contact form data
      function collectAuthContactFormData() {
        return {
          name: document.getElementById('auth-contact-name').value.trim(),
          email: document.getElementById('auth-contact-email').value.trim(),
          category: document.getElementById('auth-contact-category').value,
          title: document.getElementById('auth-contact-title').value.trim(),
          message: document.getElementById('auth-contact-message').value.trim(),
          browser: document.getElementById('auth-contact-browser').value.trim(),
          authenticated: true
        };
      }

      // Reset authenticated contact form
      function resetAuthContactForm() {
        document.getElementById('auth-contact-category').value = '';
        document.getElementById('auth-contact-title').value = '';
        document.getElementById('auth-contact-message').value = '';
        document.getElementById('auth-contact-browser').value = '';
        document.getElementById('auth-privacy-agreement').checked = false;
        document.getElementById('auth-terms-agreement').checked = false;
        document.getElementById('auth-submission-status').style.display = 'none';
      }

      // Add listener to check authentication when contact tab is opened
      const originalOpenTab = window.openTab;
      window.openTab = function(tabName) {
        originalOpenTab(tabName);
        if (tabName === 'contact') {
          setTimeout(checkContactAuthentication, 100);
        }
      };

      // デバッグ用ショートカット（開発時のみ）
      window.addEventListener("keydown", function (e) {
        if (e.ctrlKey && e.shiftKey && e.key === "F") {
          if (window.fbDebug) {
            fbDebug();
          }
        }
      });
    </script>
  </body>
</html>
