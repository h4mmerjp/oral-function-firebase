<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- セキュリティヘッダー -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self';
              script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://pagead2.googlesyndication.com;
              style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
              font-src 'self' https://fonts.gstatic.com;
              img-src 'self' data: https: blob:;
              connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.firebaseapp.com https://www.gstatic.com wss://*.firebaseio.com;
              frame-src 'self' https://accounts.google.com https://content.googleapis.com https://*.firebaseapp.com;"
    />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
    <meta
      http-equiv="Referrer-Policy"
      content="strict-origin-when-cross-origin"
    />

    <meta
      name="description"
      content="日本老年歯科医学会基準に基づく口腔機能低下症の診断・管理ツール。歯科医師・歯科衛生士向けの診断補助アプリケーション。"
    />
    <meta
      name="keywords"
      content="口腔機能,歯科,診断,管理,医療従事者,口腔機能低下症,日本老年歯科医学会"
    />
    <meta name="author" content="口腔機能低下症診断・管理アプリ" />

    <title>
      口腔機能低下症 診断・管理アプリ - 歯科医療従事者向け診断支援ツール
    </title>
    <link rel="stylesheet" href="styles.css" />

    <style>
      .landing-container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-align: center;
        padding: 20px;
      }

      .landing-card {
        background: white;
        color: #333;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        max-width: 600px;
        width: 100%;
        margin: 20px;
      }

      .landing-title {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 20px;
        color: #2c3e50;
      }

      .landing-subtitle {
        font-size: 1.2rem;
        color: #7f8c8d;
        margin-bottom: 30px;
      }

      .features-list {
        text-align: left;
        margin: 30px 0;
      }

      .feature-item {
        display: flex;
        align-items: center;
        margin: 15px 0;
        font-size: 1.1rem;
      }

      .feature-icon {
        width: 24px;
        height: 24px;
        margin-right: 15px;
        background: #27ae60;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .auth-section {
        background: #f8f9fa;
        padding: 30px;
        border-radius: 12px;
        margin: 20px 0;
      }

      .auth-title {
        font-size: 1.3rem;
        margin-bottom: 15px;
        color: #2c3e50;
      }

      .google-login-btn {
        background: #4285f4;
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 1.1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        width: 100%;
        transition: background-color 0.3s;
      }

      .google-login-btn:hover {
        background: #3367d6;
      }

      .google-login-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #ffffff;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .offline-notice {
        background: #f39c12;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        font-size: 0.9rem;
      }

      .demo-link {
        display: inline-block;
        margin-top: 20px;
        color: #3498db;
        text-decoration: none;
        font-size: 1rem;
      }

      .demo-link:hover {
        text-decoration: underline;
      }

      @media (max-width: 768px) {
        .landing-title {
          font-size: 2rem;
        }

        .landing-card {
          padding: 30px 20px;
          margin: 10px;
        }
      }
    </style>
  </head>

  <body>
    <div class="landing-container">
      <div class="landing-card">
        <h1 class="landing-title">口腔機能低下症<br />診断・管理アプリ</h1>
        <p class="landing-subtitle">
          日本老年歯科医学会の基準に基づく診断・管理ツール
        </p>

        <div class="features-list">
          <div class="feature-item">
            <div class="feature-icon">✓</div>
            <span>口腔機能精密検査の支援</span>
          </div>
          <div class="feature-item">
            <div class="feature-icon">✓</div>
            <span>診断結果の自動判定</span>
          </div>
          <div class="feature-item">
            <div class="feature-icon">✓</div>
            <span>管理計画書・記録簿の作成</span>
          </div>
          <div class="feature-item">
            <div class="feature-icon">✓</div>
            <span>患者データの安全な管理</span>
          </div>
          <div class="feature-item">
            <div class="feature-icon">✓</div>
            <span>クラウド同期でどこからでもアクセス</span>
          </div>
        </div>

        <div class="auth-section">
          <h3 class="auth-title">ログインして始める</h3>
          <p style="margin-bottom: 20px; color: #666; font-size: 0.9rem">
            患者データを安全に保存し、複数のデバイスから利用できます
          </p>

          <button
            id="google-login-btn"
            class="google-login-btn"
            onclick="handleGoogleLogin()"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 18 18"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M17.64 9.205c0-.639-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 01-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"
                fill="#4285F4"
              />
              <path
                d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 009 18z"
                fill="#34A853"
              />
              <path
                d="M3.964 10.71A5.41 5.41 0 013.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 000 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"
                fill="#FBBC05"
              />
              <path
                d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 00.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"
                fill="#EA4335"
              />
            </svg>
            <span id="login-text">Googleでログイン</span>
          </button>
        </div>

        <!-- よくある質問セクション -->
        <div class="faq-section" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
          <h3 style="font-size: 1.2rem; color: #2c3e50; margin-bottom: 20px; text-align: center;">❓ よくある質問</h3>

          <!-- FAQ コンテンツはJavaScriptで動的に読み込まれます -->
          <div id="faq-content" style="text-align: center; color: #666; padding: 20px;">
            📄 よくある質問を読み込み中...
          </div>

          <div style="margin-top: 15px; text-align: center;">
            <a href="faq.html" style="color: #3498db; text-decoration: none; font-size: 0.9rem;">すべての質問を見る</a> |
            <a href="contact.html" style="color: #3498db; text-decoration: none; font-size: 0.9rem;">お問い合わせ</a>
          </div>

        <div
          style="
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
          "
        >
        
          <p style="font-size: 0.8rem; color: #999">
            ※
            本アプリは診断補助ツールです。最終的な診断は医療従事者が行ってください。
          </p>
        </div>
      </div>
    </div>

    <!-- Firebase SDKをCDNから読み込み -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>

    <!-- Firebase設定 -->
    <script src="firebase-config.js"></script>

    <script>
      let isLoggingIn = false;

      // faq.htmlからよくある質問を動的に読み込む関数
      async function loadFAQFromExternal() {
        try {
          const response = await fetch('faq.html');
          const text = await response.text();

          // HTMLパーサーを作成
          const parser = new DOMParser();
          const doc = parser.parseFromString(text, 'text/html');

          // よくある質問のdetails要素を取得（最初の5個のみ表示）
          const faqDetails = Array.from(doc.querySelectorAll('details')).slice(0, 5);
          const faqContentDiv = document.getElementById('faq-content');

          if (faqDetails.length > 0 && faqContentDiv) {
            // コンテンツをクリア
            faqContentDiv.innerHTML = '';
            faqContentDiv.style.textAlign = 'left';

            // faq.htmlからdetails要素をコピー
            faqDetails.forEach(detail => {
              if (detail.querySelector('summary')) {
                const clonedDetail = detail.cloneNode(true);
                // index.html用にスタイルを軽く調整
                clonedDetail.style.cssText = 'margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; padding: 8px;';
                const summary = clonedDetail.querySelector('summary');
                if (summary) {
                  summary.style.cssText = 'cursor: pointer; font-weight: bold; padding: 4px 0; outline: none; font-size: 0.95rem;';
                }
                const content = clonedDetail.querySelector('p');
                if (content) {
                  content.style.cssText = 'margin: 0; font-size: 0.85rem; color: #555; line-height: 1.4;';
                  content.parentElement.style.cssText = 'border-top: 1px solid #ddd; margin-top: 8px; padding-top: 8px;';
                }

                faqContentDiv.appendChild(clonedDetail);
              }
            });

            console.log('よくある質問を動的に更新しました');
          }
        } catch (error) {
          console.log('よくある質問の動的読み込みに失敗しました:', error);
          // 失敗時はエラーメッセージを表示
          const faqContentDiv = document.getElementById('faq-content');
          if (faqContentDiv) {
            faqContentDiv.innerHTML = '<p style="color: #999; font-size: 0.9rem;">よくある質問の読み込みに失敗しました。<a href="faq.html">こちら</a>からご覧ください。</p>';
          }
        }
      }


      // Firebase初期化待ち
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          // よくある質問を動的に読み込み
          await loadFAQFromExternal();

          // Firebase初期化
          if (typeof firebaseManager !== "undefined") {
            await firebaseManager.initialize();
            console.log("Firebase初期化完了");

            // 認証状態の監視
            if (firebaseManager.auth) {
              firebaseManager.auth.onAuthStateChanged((user) => {
                if (user) {
                  console.log(
                    "ログイン済みユーザーを検出、ダッシュボードにリダイレクト"
                  );
                  window.location.href = "dashboard.html";
                } else {
                  console.log("未ログインユーザー");
                  showOfflineOption();
                }
              });
            }
          } else {
            console.error("firebaseManager が利用できません");
            showOfflineOption();
          }
        } catch (error) {
          console.error("初期化エラー:", error);
          showOfflineOption();
        }
      });

      // Googleログイン処理
      async function handleGoogleLogin() {
        if (isLoggingIn) return;

        try {
          isLoggingIn = true;
          updateLoginButton(true);

          if (!firebaseManager || !firebaseManager.isAvailable()) {
            throw new Error("Firebase が利用できません");
          }

          await firebaseManager.signInWithGoogle();
          // ログイン成功時は onAuthStateChanged でリダイレクトされる
        } catch (error) {
          console.error("ログインエラー:", error);
          isLoggingIn = false;
          updateLoginButton(false);

          // エラーメッセージの表示
          showErrorMessage(error.message || "ログインに失敗しました");
        }
      }

      // ログインボタンの状態更新
      function updateLoginButton(loading) {
        const btn = document.getElementById("google-login-btn");
        const text = document.getElementById("login-text");

        if (loading) {
          btn.disabled = true;
          text.innerHTML = '<div class="loading-spinner"></div> ログイン中...';
        } else {
          btn.disabled = false;
          text.textContent = "Googleでログイン";
        }
      }

      // オフライン時の選択肢表示
      function showOfflineOption() {
        const offlineNotice = document.getElementById("offline-notice");
        const demoLink = document.getElementById("demo-link");

        if (offlineNotice) offlineNotice.style.display = "block";
        if (demoLink) demoLink.style.display = "inline-block";
      }

      // エラーメッセージ表示
      function showErrorMessage(message) {
        // 既存のエラーメッセージを削除
        const existingError = document.getElementById("error-message");
        if (existingError) existingError.remove();

        const errorDiv = document.createElement("div");
        errorDiv.id = "error-message";
        errorDiv.style.cssText = `
        background: #e74c3c;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-size: 0.9rem;
        text-align: center;
      `;
        errorDiv.textContent = message;

        const authSection = document.querySelector(".auth-section");
        authSection.appendChild(errorDiv);

        // 5秒後に自動削除
        setTimeout(() => {
          if (errorDiv.parentElement) {
            errorDiv.remove();
          }
        }, 5000);
      }
    </script>
  </body>
</html>
